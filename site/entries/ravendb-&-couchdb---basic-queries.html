<html>
  <head>
    <title id="title">RavenDB & CouchDB - Basic Queries</title>
    <link rel="stylesheet" type="text/css" href="/style.css"></link>
    <meta name="Description" content="Rob Ashton's blog and various other things. Javascript, C#, testing, whatever.">
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-11207442-1']);
      _gaq.push(['_setDomainName', 'codeofrob.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </head>
  <body>
    <a class="subscribe" href="http://feeds.feedburner.com/RobAshton">Subscribe to my blog</a>
    <div id="blog-entry">
      <h1 id="post-title">RavenDB & CouchDB - Basic Queries</h1>
      <h6>Published on <span class="date">2010-6-2</span></h6>
      <div id="post">
		<p><strong>Previous entries in the series</strong></p>
<ul>
    <li><a href="http://codeofrob.com/archive/2010/05/31/ravendb-whats-the-difference.aspx">RavenDB – What’s the difference</a></li>
</ul>
<p>Once you have a number of documents in the database, you soon want to do more complex operations than simply retrieving a list of them.</p>
<p>Consider therefore the following and rather over-used example document:</p>
<div class="csharpcode">
<pre class="alt"><span class="lnum">   1:  </span>{</pre>
<pre><span class="lnum">   2:  </span>    title: <span class="str">"Another blog entry"</span>,</pre>
<pre class="alt"><span class="lnum">   3:  </span>    content: <span class="str">'blah blah blah'</span>,</pre>
<pre><span class="lnum">   4:  </span>    category: <span class="str">'code'</span>,</pre>
<pre class="alt"><span class="lnum">   5:  </span>    author: <span class="str">'robashton'</span></pre>
<pre><span class="lnum">   6:  </span>}</pre>
</div>
<style type="text/css">![CDATA[

.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }]]></style>
<p>Our example query would be to get all of the documents from the database that were written by a particular author AND in a certain category.</p>
<p>Obviously querying all the blogs written by a single author, or all the blogs in a certain category would be fairly expected queries too.</p>
<p><strong>Indexes in RavenDB</strong></p>
<p>In order to perform any queries whatsoever in RavenDB, we first need to create an index.</p>
<div class="csharpcode">
<pre class="alt"><span class="lnum">   1:  </span>from doc <span class="kwrd">in</span> docs</pre>
<pre><span class="lnum">   2:  </span>select <span class="kwrd">new</span> {</pre>
<pre class="alt"><span class="lnum">   3:  </span>     doc.author,</pre>
<pre><span class="lnum">   4:  </span>     doc.category</pre>
<pre class="alt"><span class="lnum">   5:  </span>};</pre>
</div>
<style type="text/css">![CDATA[

.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }]]></style>
<p>This is effectively a map function written as a LINQ query which returns a single value, an object that is a map of the values to be indexed.</p>
<p><em>Get all the documents by author and category</em></p>
<p>indexes/entriesByAuthorAndCategory?query=category:tech AND author:robashton</p>
<p><em>Get all the documents by category</em></p>
<p>indexes/entriesByAuthorAndCategory?query=category:tech</p>
<p><em>Get all the documents by author</em></p>
<p>indexes/entriesByAuthorAndCategory?query=author:robashton</p>
<p>Those queries will return a list of whole documents which match the queries passed in.</p>
<p><strong>Indexes in CouchDB</strong></p>
<p>
The same goes for CouchDB, only map functions in CouchDB have two outputs, and are written in JavaScript.</p>
<div class="csharpcode">
<pre class="alt"><span class="lnum">   1:  </span><span class="kwrd">function</span>(doc) {</pre>
<pre><span class="lnum">   2:  </span>  emit([doc.category, doc.author], doc);</pre>
<pre class="alt"><span class="lnum">   3:  </span>}</pre>
</div>
<style type="text/css">![CDATA[

.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }]]></style>
<p>  </p>
<p>Return values are specified by calling emit, and emit can be called more than once for each document, thus multiple keys can be created for each document with a single map function. The first parameter in Emit is the “key” to be searched on, and the second parameter is the data associated with that key (in this case, the document).</p>
<p><em>Get all the documents by author and category</em></p>
<p>blogs/_view/byAuthorAndCategory?startkey=["tech","robashton"]</p>
<p><em>Get all the documents by category</em></p>
<p>blogs/_view/byAuthorAndCategory?startkey=["tech"]</p>
<p><em>Get all the documents by author</em></p>
<p>Ah. This suddenly a bit more complicated. I’ve not actually managed to come to a convenient solution, as far as I can understand from the <a href="http://wiki.apache.org/couchdb/HTTP_view_API?action=show&amp;redirect=HttpViewApi">docs</a>, if you want to query <em>specific</em> fields within the key, you have to submit a POST request containing a JSON document with the fields you wish to search.</p>
<p>So it’s either that or create specific indexes for the queries you wish to perform. Performance-wise this is probably optimal but I don’t actually know for sure.</p>
<p><strong>Paging in RavenDB</strong></p>
<p>Paging in RavenDB is as simple as appending a start + pageSize to the query string</p>
<p>indexes/entriesByAuthorAndCategory?query=category:tech&amp;start=10&amp;pageSize=10</p>
<p>This will perform the query across the entire index and only retrieve the documents requested, this is an operation with trivial expense.</p>
<p><strong>Paging in CouchDB</strong></p>
<p>In CouchDb, a similar query string can be used, using “skip” and “count parameters, but these are considered expensive and instead to perform paging you should:</p>
<ul>
    <li>Get the first collection of documents, limiting by count(+1) </li>
    <li>Get the next collection of documents, starting at the last document in the first collection, limiting by count (+1) </li>
    <li>Etc </li>
</ul>
<p><strong>Summary</strong></p>
<p>This really is just a whistle-stop of some basic functionality in these two systems, although it does highlight some fairly major differences in basic functionality between them.</p>
<p>Next up some more advanced functionality will be covered, going over the differences between writing reduce functions in the two</p>
	</div>
      <div id="links">
        <a href="/">Index</a>
        <a href="http://feeds.feedburner.com/RobAshton">Subscribe</a>
        <a href="http://twitter.com/robashton">Follow me</a>
      </div>
      <div id="inqob_job_postings"></div> 
      <script type="text/javascript" charset="utf-8">
        var __inqob_settings = {
          email_address:  'robashton@codeofrob.com', 
          token:          '',
          debug: false,
          items: [{
            keyword: 'codeofrob', 
            price: 100 
          }]
        };

        (function(is) {
          var sc = document.createElement('script'); sc.type = 'text/javascript'; sc.async = true;
          var src = (document.location.protocol == 'https:' ? 'https://' : 'http://') + 'inqob.com/get/script';
          var q = [];
          q.push('?t='+ new Date().getTime()); 
          q.push('token=' + is.token); 
          q.push('email_address=' + is.email_address); 
          q.push('href=' + encodeURIComponent(window.location.href));
          sc.src = src + q.join('&');
          var s = document.getElementsByTagName('script')[0]; 
          s.parentNode.insertBefore(sc, s);
        })(__inqob_settings);      
      </script>
      <div id="disqus">
        <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'codeofrob'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
    </div>
    <div id="post-comments"><div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=9b86cc77c4d7c347ab760363e644cce0&size=50&default=identicon"/>
<p>Peter Curd</p></div>
<div class="comment-body">
<br/> 				Excellent summary! From this I can see that RavenDB makes more sense to me and supports notation I can understand. Great introduction for document database newbies like me :)What are the practical implications of having to index before you can select from a field? Does index maintenance become costly?
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=b6a6693f03003f7ab0f9b0882e9c2dde&size=50&default=identicon"/>
<p>robashton</p></div>
<div class="comment-body">
<br/> 				Does index maintenance become more costly?In RavenDB, indexing is strictly a background process, the idea being that they'll eventually become consistent (providing you aren't hammering updates in constantly). This is why it's great for low-write, high-read scenarios, because reads just look at an already computed index and are incredibly cheap.I wouldn't say it becomes *costly*, because of it being a background task, but sure - the more indexes you add, the more effort the server will have to make to keep them up to date as data is inserted/modified. That's when you look at scaling out by adding more servers and perhaps splitting your data/indexes out over those servers and using sharding strategies or whatever makes sense.
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=444625287c652a4e31f4a271905b713a&size=50&default=identicon"/>
<p>Simone Chiaretta</p></div>
<div class="comment-body">
<br/> 				Indexes here are not like indexes in relational databases: they looks to me a lot like stored procedures.What happens if I want to do the same query without having the index? Will it just scan the whole document library looking for objects with the given properties?Wouldn't it be possible to have the server itself understands the query performed and create the indexes automatically?
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=b6a6693f03003f7ab0f9b0882e9c2dde&size=50&default=identicon"/>
<p>robashton</p></div>
<div class="comment-body">
<br/> 				Very astute, indexes in these systems can be considered more like materialized views or indeed stored procedures.Put simply, you don't perform the query without having the index - Couch does support temporary indexes but they're *slow* and the point of being up front about your querying needs is to make the act of reading data from the database *cheap*Sure it would be possible to get the server to understand the query, and create the index and then query against that index - but that would be expensive and defeat the point of moving to a system like this :)
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=444625287c652a4e31f4a271905b713a&size=50&default=identicon"/>
<p>Simone Chiaretta</p></div>
<div class="comment-body">
<br/> 				With create the index automatically I meant like, creating the index just the first time, and then use it in subsequent queries like if it was defined up-front. So, after a warm up period the system will be as fast as with the manually created indexes.
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=b6a6693f03003f7ab0f9b0882e9c2dde&size=50&default=identicon"/>
<p>robashton</p></div>
<div class="comment-body">
<br/> 				Neither of the systems support this.It would be a bit hard to do it in a sensible way too.
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=444625287c652a4e31f4a271905b713a&size=50&default=identicon"/>
<p>Simone Chiaretta</p></div>
<div class="comment-body">
<br/> 				Nothing is too hard for Ayende :)
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=b6a6693f03003f7ab0f9b0882e9c2dde&size=50&default=identicon"/>
<p>robashton</p></div>
<div class="comment-body">
<br/> 				I'm sure the discussion would be welcome on the mailing list!http://groups.google.com/group/ravendb/topics
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=444625287c652a4e31f4a271905b713a&size=50&default=identicon"/>
<p>Simone Chiaretta</p></div>
<div class="comment-body">
<br/> 				Moved the conversation over there
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="/images/IdenticonHandler.ashx?code=827048241"/>
<p>Web Dev .NET</p></div>
<div class="comment-body">
<br/> 				Tech Tweets for 2-Jun-2010
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="/images/IdenticonHandler.ashx?code=-1491881005"/>
<p>Ross Hawkins</p></div>
<div class="comment-body">
<br/> 				A quick collection of useful .NET related links
				</div></div>
</div>
  </body>
</html>
