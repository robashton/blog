<html>
  <head>
    <title id="title">Re-thinking result transformations in RavenDB</title>
    <link rel="stylesheet" type="text/css" href="/style.css"></link>
    <link rel="alternate" type="application/atom+xml" href="http://feeds.feedblitz.com/robashton&x=1" title="Rob Ashton's blog" />
    <meta name="Description" content="Rob Ashton's blog and various other things. Javascript, C#, testing, whatever.">
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-11207442-1']);
      _gaq.push(['_setDomainName', 'codeofrob.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </head>
  <body>
    <a class="subscribe" href="http://feed.codeofrob.com/RobAshton">Subscribe to my blog</a>
    <div id="blog-entry">
      <h1 id="post-title">Re-thinking result transformations in RavenDB</h1>
      <h6>Published on <span class="date">2013-2-19</span></h6>
      <div id="post"><p>After all the work on indexes, things started getting downright <em>dirty</em> at the Hibernating Rhinos offices as we looked at re-vamping TransformResults in RavenDB.</p>

<p>First, a re-cap on what TransformResults actually is; consider we have a couple of documents that look something like this:</p>

<p><em>A pony</em></p>

<pre><code>    {
        id: "ponies/rainbowdash",
        name: "Rainbow Dash",
        colour: '#9EDBF9',      // I actually looked this up
        trampstamp: 'rainbow-lightning',
        petid: 'pets/tank'
    }
</code></pre>

<p><em>a pet</em></p>

<pre><code>    {
        id: "pets/tank",
        name: "Tank",
        species: "Tortoise",
        colour: '#0F0'          // I didn't look this up
    }
</code></pre>

<p>Let's say we have an index that looks like this</p>

<pre><code>    public class Ponies : AbstractIndexCreationTask&lt;Pony&gt;
    {
         public Ponies()
         {
              Map = ponies =&gt;
            from pony in ponies
                            select new {
                                pony.Name,
                                pony.Colour,
                                pony.Trampstamp
                            }
         }
    }
</code></pre>

<p>When querying for a list of blue ponies, we might actually decide we want to know what species their pets are, we have the following options</p>

<ul>
<li>Include them from the client (This brings back a lot of information that we don't need)</li>
<li>Add a results transformer to the index</li>
</ul>

<p>We mostly end up doing the last one and so we do that and it looks like this:</p>

<pre><code>    public class Ponies : AbstractIndexCreationTask&lt;Pony&gt;
    {
         public Ponies()
         {
              Map = ponies =&gt;
            from pony in ponies
                            select new {
                                pony.Name,
                                pony.Colour,
                                pony.Trampstamp
                            }
                TransformResults = (database, results) =&gt;
                        from result in results
                        let pet = database.Load&lt;Pet&gt;(result.PetId)
                        select new {
                            PonyId = pony.Id
                            Name = pony.Name,
                            PetName = pet.Name,
                            PetSpecies = pet.Species
                        }
         }
    }
</code></pre>

<p>This gives us the ability to send only the information we want to the client as well as pull in information from other documents, that's pretty neat, but now it's in need of a bit of TLC, as some of its functionality has been <a href="http://ayende.com/blog/160545/feature-intersection-is-killing-me-referenced-document-indexing">superceded by Referenced Documents in Map</a> and it's a bit awkward as it is.</p>

<p>I'll talk more about that tomorrow when I go into some of the issues that we're experiencing with this feature.</p></div>
      <div id="links">
        <a href="/">Index</a>
        <a href="http://feed.codeofrob.com/RobAshton">Subscribe</a>
        <a href="http://twitter.com/robashton">Follow me</a>
      </div>
      <div id="inqob_job_postings"></div> 
      <script type="text/javascript" charset="utf-8">
        var __inqob_settings = {
          email_address:  'robashton@codeofrob.com', 
          token:          '',
          debug: false,
          items: [{
            keyword: 'codeofrob', 
            price: 100 
          }]
        };

        (function(is) {
          var sc = document.createElement('script'); sc.type = 'text/javascript'; sc.async = true;
          var src = (document.location.protocol == 'https:' ? 'https://' : 'http://') + 'inqob.com/get/script';
          var q = [];
          q.push('?t='+ new Date().getTime()); 
          q.push('token=' + is.token); 
          q.push('email_address=' + is.email_address); 
          q.push('href=' + encodeURIComponent(window.location.href));
          sc.src = src + q.join('&');
          var s = document.getElementsByTagName('script')[0]; 
          s.parentNode.insertBefore(sc, s);
        })(__inqob_settings);      
      </script>
      <div id="disqus">
        <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'codeofrob'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
    </div>
    <div id="post-comments">

    </div>
  </body>
</html>
