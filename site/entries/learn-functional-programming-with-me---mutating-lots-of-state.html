<html>
  <head>
    <title id="title">Learn functional programming with me - Mutating lots of state</title>
    <link rel="stylesheet" type="text/css" href="/style.css"></link>
    <link href='http://fonts.googleapis.com/css?family=Libre+Baskerville' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
    <link rel="alternate" type="application/atom+xml" href="http://feeds.feedblitz.com/robashton&x=1" title="Rob Ashton's blog" />
    <meta name="Description" content="Rob Ashton's blog and various other things. Javascript, C#, testing, whatever.">
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-11207442-1']);
      _gaq.push(['_setDomainName', 'codeofrob.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </head>
  <body>
    <a class="subscribe" href="http://feed.codeofrob.com/RobAshton">Subscribe to my blog</a>
    <div id="blog-entry">
      <h1 id="post-title">Learn functional programming with me - Mutating lots of state</h1>
      <h6>Published on <span class="date">2013-5-29</span></h6>
      <div id="post"><p>It's all very well and good being able to render a load of squares based on a sequence of positions, but what I actually want to achieve now is moving all of those squares.</p>

<ul>
<li><a href="/entries/learn-functional-programming-with-me---a-mission-statement.html">Missing statement</a></li>
<li><a href="/entries/learn-functional-programming-with-me---drawing-a-square.html">Drawing a square</a></li>
<li><a href="/entries/learn-functional-programming-with-me---moving-the-square.html">Moving the square</a></li>
<li><a href="/entries/learn-functional-programming-with-me---attributes-and-vectors.html">Attributes and vectors</a></li>
<li><a href="/entries/learn-functional-programming-with-me---improving-my-workflow.html">Improving my workflow</a></li>
<li><a href="/entries/learn-functional-programming-with-me---adding-lots-more-state.html">Creating lots of state</a></li>
</ul>

<p><strong>Mutating lots of state</strong></p>

<p>Thing is, what I can't do is pop into that sequence and start <em>changing</em> state, what I want to do each frame is (I think), create a <em>new</em> sequence and pass that into the next call of 'tick', <em>erk</em>.</p>

<p>Well, actually this shouldn't be such a big deal, how about creating a method that takes in a sequence and returns a new sequence where each item is slightly different from the original?</p>

<pre><code>(defn doLogic [enemies]
  (for [[x y] enemies]
    [(inc x) y]
  )
)
</code></pre>

<p>doLogic takes in a sequence of enemies, then uses a list comprehension to create a new list of enemies but with 'x' increased by one.</p>

<p>Now all we have to do is pass this new sequence into the next call of 'tick'</p>

<pre><code>(tick (doLogic enemies))
</code></pre>

<p>Okay, that was <em>too</em> easy, from what I see here this is also going to be lazy up until the point we call 'doseq', it makes me feel kinda weird though that we're apparently creating a completely new sequence every single frame - memory-wise this has to be a bad idea and in the JS environment this is going to make me cry.</p>

<p>I have no idea what is going on under the hood though, so if any Clojurescript guru can enlighten me I'd appreciate it.</p>

<p><strong>Making our invaders move left to right and back again</strong></p>

<p>Well, the first thing I actually need to do is set up my invaders properly in some sort of known 'game space', this isn't really related to the functional programming bit so I'm going to pretty much side-step over it by modifying the code and explaining what I've done. (normally I'd use a camera system and be a bit more clever, but not the point of this exercise)</p>

<p><em>The first thing I've done is moved the ctx call outside of tick</em></p>

<pre><code>(defn ^:export init []
  (let [ctx (context)] 
    (tick ctx (initState)) 
  )
)
</code></pre>

<p>And actually, I'm going to specify the width and height as 640x480 and hard-code the whole thing</p>

<pre><code>(defn ^:export init []
  (let [ctx (context 640 480)] 
    (tick ctx (initState)) 
  )
)

(defn context [width height]
  (let [target (.getElementById js/document "target")]
    [
      (.getContext target "2d") 
      (set! (. target -width) width)
      (set! (. target -height) height)
    ]
  )
)
</code></pre>

<p>And now I've done this, I can do a little bit of maths and say that if I make my space invaders 20x20, then I can fit 8 of them on the screen horizontally and 4 vertically (leaving space for our good guy and between them!)</p>

<pre><code>(defn initState []
 (for [x (range 0 16 2)
       y (range 0 8 2)]
   [(* x 30) (* y 30) 20 20]
 )
)
</code></pre>

<p>I'm also now including a width and height with each of my little invaders, which means I'll need to modify my logic function</p>

<pre><code>(defn doLogic [enemies]
  (for [[x y w h] enemies]
    [(inc x) y w h]
  )
)
</code></pre>

<p>And rendering them now looks like this</p>

<pre><code>(doseq [[x y w h] enemies] (drawSquare ctx x y w h))
</code></pre>

<p>Now this doesn't solve that what I want to do is change the direction of my squares when they reach the edge of the playing area, this is bit more interesting.</p>

<p><strong>Variable state changes</strong></p>

<p>Well, when do my space invaders switch direction? Well, I went on <a href="http://www.youtube.com/watch?v=437Ld_rKM2s">Youtube</a> to look at the original behaviour of space invaders and it seems that if you destroy a column of invaders then it won't switch direction until at least one invader has reached the edge of the screen.</p>

<p>What's an efficient way of handling this I wonder, well I'll need a direction as part of my main game state so I'll get that in first</p>

<pre><code>(defn initState []
 [
   1
   (for [x (range 0 16 2)
         y (range 0 8 2)]
     [(* x 30) (* y 30) 20 20]
   )
 ]
)
</code></pre>

<p>Okay, so now initState will return a vector containing a direction (1), and a sequence of enemies. I'm really not confortable with these arbitrary lists of state so I'll look for some way to make them tidier shortly I think.</p>

<pre><code>(defn tick [ctx state]
  (let [[dir enemies] state]
    (clearScreen ctx) 
    (doseq [[x y w h] enemies] (drawSquare ctx x y w h))
    (js/setTimeout (fn []
      (tick ctx (doLogic state))
    ) 33  )
  )
)
</code></pre>

<p>In my tick method, I'll use a destructuring assignment to unpack this vector into a direction and an enemies sequence so I can easily go through that sequence.</p>

<pre><code>(defn doLogic [[direction enemies]]
  [
    direction
    (for [[x y w h] enemies]
      [(inc x) y w h]
    )
  ]
)
</code></pre>

<p>And in my doLogic method, I'll simply re-return the diretion, and the modified sequence of enemies.</p>

<p>All I need to do now is return a different direction if a certain condition is true</p>

<ul>
<li>Are we going right? Are any of the entities too far to the right?</li>
<li>Are we going left? Are any of the entities too far to the left?</li>
</ul>

<p>Okay, how about</p>

<pre><code>(defn doLogic [[direction enemies]]
  [
    (getNextDirection direction enemies)
    (for [[x y w h] enemies]
      (if(= direction 1)
        [(inc x) y w h]
        [(dec x) y w h]
      )
    )
  ]
)
</code></pre>

<p>We'll ask another function what the next direction is going to be, if the current direction is '1', we'll inc x, anx if the current direction is not 1, we'll dec x.</p>

<p>I can implement getNextDirection like so, taking in current and enemies</p>

<pre><code>(defn getNextDirection [current enemies]
  (if (= current 1)
    (let [right (apply max (map (fn [[x y w h] e] x) enemies))]
      (if(&gt; right 600) -1 1)
    )
    (let [left (apply min (map (fn [[x y w h] e] x) enemies))]
      (if(&lt; left 0) 1 -1)
    )
  )
)
</code></pre>

<p>I can say, if we're going right, check out what the max x position is, and change direction if it's greater than 600, and vice versa if it's not.</p>

<p>This all works, my squares go from left to right and back again and keep bouncing around.</p>

<p><img src="/img/yellow_squares.png" alt="A load of yellow squares" title="Space invaders"></p>

<p>I have another question at this point, which is "how many times is this list being iterated, should I be optimising this some how?"</p></div>
      <div id="links">
        <a href="/">Index</a>
        <a href="http://feed.codeofrob.com/RobAshton">Subscribe</a>
        <a href="http://twitter.com/robashton">Follow me</a>
      </div>
      <div id="disqus">
        <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'codeofrob'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
    </div>
    <div id="post-comments">

    </div>
  </body>
</html>
