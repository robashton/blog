<!doctype html> <!--[if ie 7]> <html lang="en" class="ie7"> <![endif]-->  
<!--[if ie 8]> <html lang="en" class="ie8"> <![endif]-->  
<!--[if ie 9]> <html lang="en" class="ie9"> <![endif]-->  
<!--[if !ie]><!--> 
<html lang="en"> <!--<![endif]-->  
<head>
    <title id="title">Less abstract, pumping data from Github into the EventStore</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="/style.css"></link>
    <link rel="stylesheet" type="text/css" href="/rainbow.css"></link>
    <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="Description" content="Rob Ashton's blog and various other things. Javascript, C#, testing, whatever.">
    <meta name="author" content="">
    <link rel="alternate" type="application/atom+xml" href="http://feed.codeofrob.com/RobAshton" title="Rob Ashton's blog" />
    <link rel="stylesheet" href="/assets/plugins/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/headers/header1.css">
    <link rel="stylesheet" href="/assets/plugins/bootstrap/css/bootstrap-responsive.min.css">
    <link rel="stylesheet" href="/assets/css/style_responsive.css">
    <link rel="shortcut icon" href="/favicon.ico">        
    <link rel="stylesheet" href="/assets/plugins/font-awesome/css/font-awesome.css">
    <link rel="stylesheet" href="/assets/css/themes/default.css">
    <script type="text/javascript" src="/assets/js/jquery-1.8.2.min.js"></script>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-11207442-1']);
      _gaq.push(['_setDomainName', 'codeofrob.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>

  <body>
    <div class="header">               
        <div class="container"> 
            <div class="logo">                                             
              <h2><a href="index.html">Rob Ashton</a></h2>
            </div>
            <div class="navbar">                                
                <div class="navbar-inner">                                  
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                      <span class="icon-bar"></span>
                      <span class="icon-bar"></span>
                      <span class="icon-bar"></span>
                    </a>
                    <div class="nav-collapse collapse">                                     
                        <ul class="nav top-2">
                          <li>
                                <a href="/">Home</a>
                            </li>
                            <li>
                                <a href="/blog.html">Blog</a>
                            </li>
                            <li>
                                <a href="/testimonials.html">Testimonials</a>
                            </li>
                            <li>
                                <a href="/hire.html">Hire Me</a>
                            </li>
                    </div>
                </div>
            </div>
        </div>
    </div>

  <body>
    <div id="blog-entry">
      <h1 id="post-title">Less abstract, pumping data from Github into the EventStore</h1>
      <h6>Published on <span class="date">2013-5-2</span></h6>
      <div id="post"><p>It&#39;s all very well and good <a href="/entries/playing-with-the-eventstore.html">talking</a> <a href="/entries/pushing-data-into-streams-in-the-eventstore.html">events</a> <a href="/entries/basic-projections-in-the-eventstore.html">in</a> <a href="/entries/re-partitioning-streams-in-the-event-store-for-better-projections.html">the</a> <a href="/entries/creating-a-projection-per-stream-in-the-eventstore.html">abstract</a>, but there is only so long I can blather about ponies before I run out of the kind of data I can ask interesting questions about.</p>
<p>We turn to the <a href="http://developer.github.com/v3/activity/events/#list-public-events">Github Events API</a>, something I have a <a href="/entries/github-live.html">bit of experience</a> with for inspiration and start dumping all the events into the event store.</p>
<p>What does this look like?</p>
<p>Well, I&#39;m interested in the public events stream, which can be polled up to 5000 times an hour (at current rates, it needs polling about every 10 seconds in order to keep up, so I&#39;ll not be able to get them all)</p>
<p>What this looks like</p>
<pre><code> var request = https.get(
 { host:<span class="string"> 'api.github.com'</span>, path:<span class="string"> '/events'</span> + auth }, 
 function(res) {
    var <span class="typedef"><span class="keyword">data</span> = ''</span>
    res.on('<span class="typedef"><span class="keyword">data</span>', function <span class="container">(<span class="title">chunk</span>)</span> <span class="container">{
      <span class="title">data</span> += <span class="title">chunk</span>
    }</span>);</span>
    res.on('end', function() {
      processData(<span class="typedef"><span class="keyword">data</span>)</span>
    })
  })
  .on('error', function(e) {
    console.error(e)
  }).end()

  var processData = function(<span class="typedef"><span class="keyword">data</span>) <span class="container">{
    <span class="title">var</span> <span class="title">eventArray</span> = <span class="type">JSON</span>.<span class="title">parse</span>(<span class="title">data</span>)
    <span class="title">for</span>(<span class="title">var</span> <span class="title">i</span> = <span class="title">eventArray</span>.<span class="title">length</span>-1 ; <span class="title">i</span> &gt;= 0; <span class="title">i</span>--) {
      <span class="title">processEvent</span>(<span class="title">eventArray</span>[<span class="title">i</span>])
    }</span></span>
  }</code></pre>
<p>An event looks like this</p>
<pre><code>{
  <span class="property">id</span>: <span class="string">"somelongid"</span>,
  type: <span class="string">"PushEvent"</span>,
  actor: { // info <span class="keyword">about</span> <span class="keyword">the</span> user },
  repo: { // info <span class="keyword">about</span> <span class="keyword">the</span> repo }
  payload: { // <span class="keyword">the</span> event itself }
}</code></pre>
<p>I&#39;m going to be shoving these events &#39;as is&#39; into the EventStore, and using their ids &#39;as is&#39; too, this means I don&#39;t need to do any de-duping or anything like that.</p>
<p>Now, because of the kind of question I want to ask, it isn&#39;t enough for me to have the scant info about a repo that the event stream gives me (it looks like this)</p>
<pre><code>{
 "<span class="attribute">id</span>": <span class="value"><span class="number">3</span></span>,
 "<span class="attribute">name</span>": <span class="value"><span class="string">"octocat/Hello-World"</span></span>,
 "<span class="attribute">url</span>": <span class="value"><span class="string">"https://api.github.com/repos/octocat/Hello-World"</span>
}</span></code></pre>
<p>So I&#39;m going to augment each event with repo information (this is quite common in the eventing world, augmenting events with useful information for query purposes), and therefore my processEvent method looks something like this:</p>
<pre><code><span class="function"><span class="keyword">function</span> <span class="title">processEvent</span><span class="params">(ev)</span> {</span>
  <span class="keyword">if</span>(<span class="transposed_variable">ev.</span>repo) <span class="cell">{
    fetchRepoInfo(ev.repo.name, function(repo) {
      ev.repo = repo
      pushEventIntoEventStore(ev)
    }</span>)
  } <span class="keyword">else</span> <span class="cell">{
    pushEventIntoEventStore(ev)
  }</span>
}</code></pre>
<p>So, I&#39;m not altering any of the events in any way, except by adding repo information to them, therefore if you&#39;re interested in the structure of any of the events I&#39;m using you can easily look them up in the API.</p>
<p>By the time the code is readable there&#39;ll be some rate management code in there because I can&#39;t go looking up repo information for every single event and not go over the rate limit, but it&#39;s safe to say we&#39;ll be getting ~50% of the events from Github and that&#39;s a reasonable amount.</p>
<p>My script simply sits there running in the background and throws events into the event store and this little experiment is going to be about creating projections and asking questions of those events as we go along. Capiche? :)</p>
</div>
      <div id="links">
        <a href="/">Index</a>
        <a href="http://feed.codeofrob.com/RobAshton">Subscribe</a>
        <a href="http://twitter.com/robashton">Follow me</a>
      </div>
      <div id="hire-me">
        <h6>Why not hire me?</h6>
        <p>I am available for emergency consults, workshops, training and short-term development work anywhere in Europe</p>
        <p>C#, JavaScript, Clojure, RavenDB, NodeJS, Architecture review.. etc</p>
        <p><a href="mailto:robashton@codeofrob.com">Get in touch</a></p>
      </div>
      <div id="disqus">
        <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'codeofrob'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
    </div>
    <div id="post-comments">

    </div>

<div class="footer" style="margin-top: 0px">
    <div class="container">
        <div class="row-fluid">
            <div class="span3">
                <div class="headline"><h3>Get In Touch</h3></div>
                <address class="address">
                    <ul class="icons-ul">
                        <li><i class="icon-li icon-envelope"></i>Email: <a href="mailto:robashton@codeofrob.com" class="">robashton@codeofrob.com</a></li>
                        <li><i class="icon-li icon-envelope"></i>Skype: <a href="skype:rob_ashton" class="">rob_ashton</a></li>
                    </ul>
                </address>
            </div><!--/span3-->
            <div class="span5">
                <div class="headline"><h3>Subscribe</h3></div>
                <p>I publish an <a href="http://feed.codeofrob.com/RobAshton">RSS feed</a> from my blog and some other activities</p>
            </div>
            <div class="span4">
                <div class="posts">
                  <div class="headline"><h3>Find me...</h3></div>
                  <p><a href="http://twitter.com/robashton"><img src="/assets/img/twitter.jpg" alt="" />
                  <a href="http://github.com/robashton"><img src="/assets/img/github.png" alt="" /></a></p>
                </div>
            </div><!--/span4-->
        </div><!--/row-fluid-->
    </div><!--/container-->
</div><!--/footer-->
<!--=== End Footer ===-->

<!--=== Copyright ===-->
<div class="copyright">
    <div class="container">
        <div class="row-fluid">
            <div class="span2">
              <a href="/">Rob Ashton</a>
            </div>
            <div class="span6">
              <p class="terms">2013 © Rob Ashton. ALL Rights Reserved.</p>
            </div>
        </div><!--/row-fluid-->
    </div><!--/container-->
</div><!--/copyright-->
<!--=== End Copyright ===-->

<!-- JS Global Compulsory -->			
<script type="text/javascript" src="/assets/js/modernizr.custom.js"></script>		
<script type="text/javascript" src="/assets/plugins/bootstrap/js/bootstrap.min.js"></script>	
<!-- JS Implementing Plugins -->           
<script type="text/javascript" src="/assets/plugins/flexslider/jquery.flexslider-min.js"></script>
<script type="text/javascript" src="/assets/plugins/parallax-slider/js/modernizr.js"></script>
<script type="text/javascript" src="/assets/plugins/parallax-slider/js/jquery.cslider.js"></script>
<script type="text/javascript" src="/assets/plugins/back-to-top.js"></script>
<script type="text/javascript" src="/assets/plugins/jquery.sticky.js"></script>
<script type="text/javascript" src="/assets/plugins/fancybox/source/jquery.fancybox.pack.js"></script>
<!-- JS Page Level -->           
<script type="text/javascript" src="/assets/js/app.js"></script>
<script type="text/javascript" src="/assets/js/pages/index.js"></script>
<script type="text/javascript">
    jQuery(document).ready(function() {
      	App.init();
        App.initFancybox();
        App.initSliders();
        Index.initParallaxSlider();
    });
</script>
<!--[if lt IE 9]>
    <script src="assets/js/respond.js"></script>
<![endif]-->
  </body>
</html>

