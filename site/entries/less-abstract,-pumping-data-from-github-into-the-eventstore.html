<html>
  <head>
    <title id="title">Less abstract, pumping data from Github into the EventStore</title>
    <link rel="stylesheet" type="text/css" href="/style.css"></link>
    <link rel="stylesheet" type="text/css" href="/rainbow.css"></link>
    <link href='http://fonts.googleapis.com/css?family=Libre+Baskerville' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
    <link rel="alternate" type="application/atom+xml" href="http://feeds.feedblitz.com/robashton&x=1" title="Rob Ashton's blog" />
    <meta name="Description" content="Rob Ashton's blog and various other things. Javascript, C#, testing, whatever.">
    <script type="text/javascript" src="/jquery.js"></script>
    <script type="text/javascript" src="/post.js"></script>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-11207442-1']);
      _gaq.push(['_setDomainName', 'codeofrob.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </head>
  <body>
    <a class="subscribe" href="http://feed.codeofrob.com/RobAshton">Subscribe to my blog</a>
    <div id="blog-entry">
      <h1 id="post-title">Less abstract, pumping data from Github into the EventStore</h1>
      <h6>Published on <span class="date">2013-5-2</span></h6>
      <div id="post"><p>It&#39;s all very well and good <a href="/entries/playing-with-the-eventstore.html">talking</a> <a href="/entries/pushing-data-into-streams-in-the-eventstore.html">events</a> <a href="/entries/basic-projections-in-the-eventstore.html">in</a> <a href="/entries/re-partitioning-streams-in-the-event-store-for-better-projections.html">the</a> <a href="/entries/creating-a-projection-per-stream-in-the-eventstore.html">abstract</a>, but there is only so long I can blather about ponies before I run out of the kind of data I can ask interesting questions about.</p>
<p>We turn to the <a href="http://developer.github.com/v3/activity/events/#list-public-events">Github Events API</a>, something I have a <a href="/entries/github-live.html">bit of experience</a> with for inspiration and start dumping all the events into the event store.</p>
<p>What does this look like?</p>
<p>Well, I&#39;m interested in the public events stream, which can be polled up to 5000 times an hour (at current rates, it needs polling about every 10 seconds in order to keep up, so I&#39;ll not be able to get them all)</p>
<p>What this looks like</p>
<pre><code> var request = https.get(
 { host:<span class="string"> 'api.github.com'</span>, path:<span class="string"> '/events'</span> + auth }, 
 function(res) {
    var <span class="typedef"><span class="keyword">data</span> = ''</span>
    res.on('<span class="typedef"><span class="keyword">data</span>', function <span class="container">(<span class="title">chunk</span>)</span> <span class="container">{
      <span class="title">data</span> += <span class="title">chunk</span>
    }</span>);</span>
    res.on('end', function() {
      processData(<span class="typedef"><span class="keyword">data</span>)</span>
    })
  })
  .on('error', function(e) {
    console.error(e)
  }).end()

  var processData = function(<span class="typedef"><span class="keyword">data</span>) <span class="container">{
    <span class="title">var</span> <span class="title">eventArray</span> = <span class="type">JSON</span>.<span class="title">parse</span>(<span class="title">data</span>)
    <span class="title">for</span>(<span class="title">var</span> <span class="title">i</span> = <span class="title">eventArray</span>.<span class="title">length</span>-1 ; <span class="title">i</span> &gt;= 0; <span class="title">i</span>--) {
      <span class="title">processEvent</span>(<span class="title">eventArray</span>[<span class="title">i</span>])
    }</span></span>
  }</code></pre>
<p>An event looks like this</p>
<pre><code>{
  <span class="property">id</span>: <span class="string">"somelongid"</span>,
  type: <span class="string">"PushEvent"</span>,
  actor: { // info <span class="keyword">about</span> <span class="keyword">the</span> user },
  repo: { // info <span class="keyword">about</span> <span class="keyword">the</span> repo }
  payload: { // <span class="keyword">the</span> event itself }
}</code></pre>
<p>I&#39;m going to be shoving these events &#39;as is&#39; into the EventStore, and using their ids &#39;as is&#39; too, this means I don&#39;t need to do any de-duping or anything like that.</p>
<p>Now, because of the kind of question I want to ask, it isn&#39;t enough for me to have the scant info about a repo that the event stream gives me (it looks like this)</p>
<pre><code>{
 "<span class="attribute">id</span>": <span class="value"><span class="number">3</span></span>,
 "<span class="attribute">name</span>": <span class="value"><span class="string">"octocat/Hello-World"</span></span>,
 "<span class="attribute">url</span>": <span class="value"><span class="string">"https://api.github.com/repos/octocat/Hello-World"</span>
}</span></code></pre>
<p>So I&#39;m going to augment each event with repo information (this is quite common in the eventing world, augmenting events with useful information for query purposes), and therefore my processEvent method looks something like this:</p>
<pre><code><span class="function"><span class="keyword">function</span> <span class="title">processEvent</span><span class="params">(ev)</span> {</span>
  <span class="keyword">if</span>(<span class="transposed_variable">ev.</span>repo) <span class="cell">{
    fetchRepoInfo(ev.repo.name, function(repo) {
      ev.repo = repo
      pushEventIntoEventStore(ev)
    }</span>)
  } <span class="keyword">else</span> <span class="cell">{
    pushEventIntoEventStore(ev)
  }</span>
}</code></pre>
<p>So, I&#39;m not altering any of the events in any way, except by adding repo information to them, therefore if you&#39;re interested in the structure of any of the events I&#39;m using you can easily look them up in the API.</p>
<p>By the time the code is readable there&#39;ll be some rate management code in there because I can&#39;t go looking up repo information for every single event and not go over the rate limit, but it&#39;s safe to say we&#39;ll be getting ~50% of the events from Github and that&#39;s a reasonable amount.</p>
<p>My script simply sits there running in the background and throws events into the event store and this little experiment is going to be about creating projections and asking questions of those events as we go along. Capiche? :)</p>
</div>
      <div id="links">
        <a href="/">Index</a>
        <a href="http://feed.codeofrob.com/RobAshton">Subscribe</a>
        <a href="http://twitter.com/robashton">Follow me</a>
      </div>
      <div id="disqus">
        <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'codeofrob'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
    </div>
    <div id="post-comments">

    </div>
  </body>
</html>
