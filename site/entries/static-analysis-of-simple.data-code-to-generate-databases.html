<html>
  <head>
    <title id="title">Static analysis of Simple.Data code to generate databases</title>
    <link rel="stylesheet" type="text/css" href="/style.css"></link>
    <link href='http://fonts.googleapis.com/css?family=Libre+Baskerville' rel='stylesheet' type='text/css'>
    <link rel="alternate" type="application/atom+xml" href="http://feeds.feedblitz.com/robashton&x=1" title="Rob Ashton's blog" />
    <meta name="Description" content="Rob Ashton's blog and various other things. Javascript, C#, testing, whatever.">
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-11207442-1']);
      _gaq.push(['_setDomainName', 'codeofrob.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </head>
  <body>
    <a class="subscribe" href="http://feed.codeofrob.com/RobAshton">Subscribe to my blog</a>
    <div id="blog-entry">
      <h1 id="post-title">Static analysis of Simple.Data code to generate databases</h1>
      <h6>Published on <span class="date">2011-4-4</span></h6>
      <div id="post">
		<p>The dynamic keyword in C#4 has been put to some good use already - and has attracted a few detractors (probably because dynamic is to C# as generic is to Java), but the fact that the dynamic keyword compiles down to simple reflection over System.Object does present some interesting possibilities over its more pure counterparts.</p>

<p>I had this thought at the weekend whilst doing something completely unrelated, and a brief Google suggested nobody else has bothered doing it with Mark Rendle's <a href="https://github.com/markrendle/Simple.Data">Simple.Data</a> yet, so here I am with a proof of concept scribbled down after a couple of hours work this evening.</p>

<p>Given the following code:</p>

<script src="https://gist.github.com/902388.js?file=Model.cs"></script>

<p>I want to end up with a database table that looks like:</p>

<script src="https://gist.github.com/902388.js?file=database.sql"></script>

<p>Looking at it, this is actually quite a simple problem, and we have two possible solutions to follow if a as a user, we are to do this without writing any further code on top of this.</p>

<ul>
<li>Create/modify the database as the code is executed</li>
<li>Analyse the compiled IL and figure it out from there</li>
</ul>

<p>Both have their merits and cons (and some cons are definitely shared hah), but from an accessibility point of view being able to do either of these would be pretty "cool"</p>

<p>I'm going for option 2, because I haven't done any IL in a while and want to remind folks that I'm not just a JS monkey, but still care about those .NET leanings too ;-)</p>

<p>Looking at the above code, as a user we can work out that the various columns and tables exist, and their types, so this should mean we can do the same programnatically against the compiled IL.</p>

<p>Let's look at the compiled IL for the first method as dumped out with Mono.Cecil in my immediate Window:</p>

<script src="https://gist.github.com/902388.js?file=gistfile10.cs"></script>

<p>Okay, that's quite daunting, but breaking it down we can easily understand what is going on (I haven't read any docs, I just read the IL and figured it out, so I could be wrong :)</p>

<ul>
<li>First up, we look at a compiled generated static field and if it's present we skip forward by about 30 instructions</li>
<li>If it's not present, we load up the name of our method call (FindByUsername) and do some reflection to get information about that method call</li>
<li>We then do the same with the property access (Users)</li>
<li>Arriving at the point we would have skipped ahead to if those values had been present, we realise they are cached information about the calls to the "Object", only loaded once (sensible as Reflection is expensive yeah?</li>
<li>At this point, we can safely load up the arguments into the stack and make a call via the Callvirt to the cached reflection information on the DB object</li>
</ul>

<p>This is nice and simple, the only information we haven't got for sure is that those dynamic calls are actually being made to a SimpleData object because it's just a System.Object once compiled. I figure it might be possible to trace through the code to find at what point that object was actually created via the Open call, but that's way beyond the scope of this blog post.</p>

<p>As for analysing this, we have Mono.Cecil so may as well write a feature test to try our initial play out.</p>

<script src="https://gist.github.com/902388.js?file=FeatureTest.cs"></script>

<p>I'm not going to be clever about this, as it's just a play-about, so let's dive in and see what information we can find in the assembly - to do this we enumerate the types and pass them into some type of scanner.</p>

<script src="https://gist.github.com/902388.js?file=ModelScanner.cs"></script>

<p>We then have a look at all the methods on that type (duh)</p>

<script src="https://gist.github.com/902388.js?file=MethodScanning.cs"></script>

<p>The important information is found in the method call, and the important stuff we want to look for in a method is (for now):</p>

<ul>
<li>Are there any dynamic method calls made?</li>
<li>Are there any references to cached fields (Callsites)</li>
</ul>

<p>With this in mind, I can think about how to identify these things</p>

<p>Looking at whether we have any method calls (returning references to those instructions - we just look for any call virts to an Invoke method (This is hardly fail-safe, but it'll easily do for that test)</p>

<script src="https://gist.github.com/902388.js?file=ExtractDynamicMethodCallInstructions.cs"></script>

<p>Looking at any cached references to reflected data, again we just look for a loading of a field, the subsequent "goto", and check the type of the field (Callsite)</p>

<script src="https://gist.github.com/902388.js?file=ExtractInitialReflectedCachedFieldReferenceInstructions.cs"></script>

<p>I can use these methods to get me information about what is going on here, and just check we're in a method that actually does something similar to what we're interested in.</p>

<script src="https://gist.github.com/902388.js?file=Check.cs"></script>

<p>The references to those fields will yield in interesting information about the table/column we are dealing with in Simple.Data, that is - the names of those objects.</p>

<p>I find this by going to that instruction and looking for the inevitable call to Ldstr, loading the name of the method call/property access onto the stack before making the reflection call.</p>

<script src="https://gist.github.com/902388.js?file=FieldNames.cs"></script>

<p>So far so good, now I just need the type of the argument passed into the call, and I achieve that by looking at the arguments being loaded into the actual method call</p>

<p>Can you say hacky? I just look at the previous instruction and if it's a ldstr I know the argument is a string :)</p>

<script src="https://gist.github.com/902392.js?file=methodssearch.cs"></script>

<p>All that is left is the putting together of this information into the model we're building.</p>

<script src="https://gist.github.com/902392.js?file=parsing%20the%20data.cs"></script>

<p>This gives me an in memory model of the database, with the name of the table and the column we've found - creating a DB creation script from this is a trivial task left to the imagination by the reader (My Sql is awful man!)</p>

<p>This is where I stopped as I don't have much time to go further tonight, if anybody wants to fork the repository and carry on where I left off, it can be found here: <a href="https://github.com/robashton/Simple.Data.Generation">https://github.com/robashton/Simple.Data.Generation</a></p>

<p>Clearly the rest of the work takes the following path if it was to be continued:</p>

<ul>
<li>Check for all the other types of 'const' to be passed into Simple.Data method calls</li>
<li>Check for arguments/local variables being passed into the Simple.Data method calls</li>
<li>Allow for multiple arguments to Simple.Data method calls</li>
<li>Deal with other types of Simple.Data method call other than FindBy</li>
<li>Deal with dynamic operations being passed to other dynamic operations (Simple.Data does this)</li>
</ul>

<p>Is this actually a good idea? Possibly? Possibly not? I haven't read about the implementation of dynamic behind the scenes by the compiler (literally, not at all) - and don't know how much is left up the compiler when choosing how to do it (Looking at those cached fields...), and this particular script makes quite a lot of assumptions about this.</p>

<p>As an example of what implementing the dynamic key word on top of a statically typed language and runtime brings to us though, it's quite powerful - and it would be interesting to see it pushed further.</p>

<p>Thoughts?</p>


	</div>
      <div id="links">
        <a href="/">Index</a>
        <a href="http://feed.codeofrob.com/RobAshton">Subscribe</a>
        <a href="http://twitter.com/robashton">Follow me</a>
      </div>
      <div id="inqob_job_postings"></div> 
      <script type="text/javascript" charset="utf-8">
        var __inqob_settings = {
          email_address:  'robashton@codeofrob.com', 
          token:          '',
          debug: false,
          items: [{
            keyword: 'codeofrob', 
            price: 100 
          }]
        };

        (function(is) {
          var sc = document.createElement('script'); sc.type = 'text/javascript'; sc.async = true;
          var src = (document.location.protocol == 'https:' ? 'https://' : 'http://') + 'inqob.com/get/script';
          var q = [];
          q.push('?t='+ new Date().getTime()); 
          q.push('token=' + is.token); 
          q.push('email_address=' + is.email_address); 
          q.push('href=' + encodeURIComponent(window.location.href));
          sc.src = src + q.join('&');
          var s = document.getElementsByTagName('script')[0]; 
          s.parentNode.insertBefore(sc, s);
        })(__inqob_settings);      
      </script>
      <div id="disqus">
        <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'codeofrob'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
    </div>
    <div id="post-comments"><div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=6a69d8c12aadd1052a5a65cb9023e783&size=50&default=identicon"/>
<p>fschwiet</p></div>
<div class="comment-body">
<br/> 				Hmm that's a cool idea.  It seems its going to get a lot tougher though when you need to generate a database update script for an existing application, even when the original database schema was created by the same tool.
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=b6a6693f03003f7ab0f9b0882e9c2dde&size=50&default=identicon"/>
<p>robashton</p></div>
<div class="comment-body">
<br/> 				That's just the standard "compare and contrast" these two database schemas right? :-)
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="/images/IdenticonHandler.ashx?code=1240913002"/>
<p>[ICR]</p></div>
<div class="comment-body">
<br/> 				Interesting. I tried using Cecil for reflection for a similar project of code generation based on property access on a dynamic object after I discovered you can't use dynamic in expression trees, but couldn't get it to work. Maybe I'll have a peek at your code at some point to see if that can set me back on the right track.
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=0e747083685b78a6fb3f264b48ab253d&size=50&default=identicon"/>
<p>tobi</p></div>
<div class="comment-body">
<br/> 				This is a disgusting and unneeded hack. It adds no value. It is just a toy made for the sake of doing new and interesting stuff, not for adding productivity. What about generating a database schema from fractals? Sounds fun.
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=b6a6693f03003f7ab0f9b0882e9c2dde&size=50&default=identicon"/>
<p>robashton</p></div>
<div class="comment-body">
<br/> 				"It is just a toy made for the sake of doing new and interesting stuff"No shit, it's called a blog.
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=0e747083685b78a6fb3f264b48ab253d&size=50&default=identicon"/>
<p>tobi</p></div>
<div class="comment-body">
<br/> 				Yeah I was being mean. Sry about that. I still stand by my opinion though.
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=0e747083685b78a6fb3f264b48ab253d&size=50&default=identicon"/>
<p>tobi</p></div>
<div class="comment-body">
<br/> 				Sometimes I think being able to act anonymously on the internet is a bad trait. It certainly was in this case. To finally add some value: I think this approach does not add anything because there is no difference between 'db.Users.FindByID(1)' and 'db.GetTable("Users").AddIdentity("ID")'. Both are string based. However the dynamic approach adds complexity to no end and requires the programmer to have a bigger working set of concepts because it is not self documenting how it works.
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=b6a6693f03003f7ab0f9b0882e9c2dde&size=50&default=identicon"/>
<p>robashton</p></div>
<div class="comment-body">
<br/> 				We're talking about the viability of Simple.Data or we talking about the blog post?The blog post I can agree with on the 'would I do this to completion' scale, it was clearly a bit of fun to see how far something can be pushed,  with a nice write-up so others may benefit from the learnings. I can actually think of some good uses of static analysis that don't involve database generation. The key word is probably analysis.On Simple.Data I cannot agree, I've seen a lot of people picking it up lately and being rather happy with how it functions, as a way of just "getting stuff done" in a legible and non-ceremonial way its value has already been demonstrated. It might not be the tool for you, and it's certainly not the tool for me in a lot of the applications I develop, but it is a valuable tool for a lot of other people in the .NET space.
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=0e747083685b78a6fb3f264b48ab253d&size=50&default=identicon"/>
<p>tobi</p></div>
<div class="comment-body">
<br/> 				I did not talk about Simple.Data which I did not notice before today but I can see clear value in Simple.Data for certain users. I would actually recommend it to beginners. How much easier could it be to start writing data access in .net?
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="/images/IdenticonHandler.ashx?code=1495197915"/>
<p>rock-meister</p></div>
<div class="comment-body">
<br/> 				Another (related) area where static analysis would be really beneficial is to check the validity of the sql that is generated.  Since the table names and column names are strings, I see value in doing a static analysis (post compile) to report errors in the sql.Thoughts?rock-meister
				</div></div>
</div>
  </body>
</html>
