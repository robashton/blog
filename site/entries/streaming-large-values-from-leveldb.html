<html>
  <head>
    <title id="title">Streaming large values from LevelDB</title>
    <link rel="stylesheet" type="text/css" href="/style.css"></link>
    <meta name="Description" content="Rob Ashton's blog and various other things. Javascript, C#, testing, whatever.">
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-11207442-1']);
      _gaq.push(['_setDomainName', 'codeofrob.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </head>
  <body>
    <a class="subscribe" href="http://feeds.feedburner.com/RobAshton">Subscribe to my blog</a>
    <div id="blog-entry">
      <h1 id="post-title">Streaming large values from LevelDB</h1>
      <div id="post"><p>We've uncovered that we can do <a href="/entries/basic-operations-with-leveldb.htm">atomic writes</a>, <a href="/entries/transactional-guarantees-on-top-of-leveldb.html">consistent reads</a> and <a href="/entries/writing-a-transaction-manager-on-top-of-leveldb.html">implement transactions</a> on top of LevelDB, but we've got another need in RavenDB which is that we have large objects inside RavenDB and we don't always want to load them into managed memory as a whole unit.</p>

<p>Why not? Because large objects can wreck havoc with the garbage collector, and we also have streaming APIs in RavenDB that allow us to limit this sort of thing that we'd like to honour.</p>

<p>So, back to C++ as we answer the question "What about large objects inside LevelDB"?</p>

<p>Looking at the APIs in our first entry, we can see that "Get" will load entire value into memory ala this:</p>

<pre><code>db-&gt;Get(leveldb::ReadOptions(), key, &amp;document);
</code></pre>

<p>We <em>could</em> simply read bytes from this document (remember, it's an std::string) and marshal them through to C# bit by bit, but that means copying the whole document out of the store before doing this.</p>

<p>That's where Slice comes in.</p>

<pre><code>  leveldb::Iterator* it = this-&gt;db-&gt;NewIterator(leveldb::ReadOptions());
  for (it-&gt;Seek(key); it-&gt;Valid() &amp;&amp; it-&gt;key().ToString() &lt;= key; it-&gt;Next()) {
    Slice* slice = it-&gt;value();

    // Do stuff with a slice
  }
</code></pre>

<p>This is quite cool, LevelDB gives us the notion of a "Slice", which is merely a pointer to the beginning of the value, and the length of the value.</p>

<p>A "Get" operation merely copies this data into an std::string, and calling slice->ToString() will do this as well.</p>

<p>What we can do is </p>

<pre><code>char buffer[1024];
memcpy(slice-&gt;data(), buffer, 1024);
</code></pre>

<p>Rinse and repeat, we can actually do this within an enumerator and send appropriately sized chunks aross to C# to be processed without copying the whole thing out at once.</p>

<p>Whether this is necessary or not..., well it's nice to know we have the flexibility to touch and manipulate the memory as we need to.</p>

<p>Most likely, copying into the string and using string.c_str() to get the pointer to the copied data will give us easier code - we'll see how that works out when it comes to writing the C# we need.</p>

<p>Anyway, now we just need support for secondary indexes, and for this I'll write a rudimentary document store.</p></div>
      <div id="links">
        <a href="/">Index</a>
        <a href="http://feeds.feedburner.com/RobAshton">Subscribe</a>
        <a href="http://twitter.com/robashton">Follow me</a>
      </div>
      <div id="inqob_job_postings"></div> 
      <script type="text/javascript" charset="utf-8">
        var __inqob_settings = {
          email_address:  'robashton@codeofrob.com', 
          token:          '',
          debug: false,
          items: [{
            keyword: 'codeofrob', 
            price: 100 
          }]
        };

        (function(is) {
          var sc = document.createElement('script'); sc.type = 'text/javascript'; sc.async = true;
          var src = (document.location.protocol == 'https:' ? 'https://' : 'http://') + 'inqob.com/get/script';
          var q = [];
          q.push('?t='+ new Date().getTime()); 
          q.push('token=' + is.token); 
          q.push('email_address=' + is.email_address); 
          q.push('href=' + encodeURIComponent(window.location.href));
          sc.src = src + q.join('&');
          var s = document.getElementsByTagName('script')[0]; 
          s.parentNode.insertBefore(sc, s);
        })(__inqob_settings);      
      </script>
      <div id="disqus">
        <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'codeofrob'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
    </div>
    <div id="post-comments">

    </div>
  </body>
</html>
