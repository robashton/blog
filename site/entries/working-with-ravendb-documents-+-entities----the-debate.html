<html>
  <head>
    <title id="title">Working with RavenDB Documents + Entities  - The Debate</title>
    <link rel="stylesheet" type="text/css" href="/style.css"></link>
    <link href='http://fonts.googleapis.com/css?family=Libre+Baskerville' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
    <link rel="alternate" type="application/atom+xml" href="http://feeds.feedblitz.com/robashton&x=1" title="Rob Ashton's blog" />
    <meta name="Description" content="Rob Ashton's blog and various other things. Javascript, C#, testing, whatever.">
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-11207442-1']);
      _gaq.push(['_setDomainName', 'codeofrob.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </head>
  <body>
    <a class="subscribe" href="http://feed.codeofrob.com/RobAshton">Subscribe to my blog</a>
    <div id="blog-entry">
      <h1 id="post-title">Working with RavenDB Documents + Entities  - The Debate</h1>
      <h6>Published on <span class="date">2010-10-4</span></h6>
      <div id="post">
		<p>Okay, fine – hands up – I knew that what I was doing with my entities would stir up some lively debate – thankfully the vast majority of which has not been centered around whether or not entities should have behaviour, but over whether or not the solution provided is optimal given the aims of the project.&nbsp; If you’re not that familiar with RavenDB then some of this discussion might not be that easy to understand -&nbsp; although largely it’s just a lateral step from the old debate with ORMs like NHibernate.</p>  <p><strong>An introduction</strong></p>  <p>I’m a big fan of the <em>concept </em>and <em>intent</em> of CQRS, and firmly believe that separating the responsibility of querying (views) from the responsibility of enacting change (commands/entities) is a <em>good thing</em>. This topic has been done to death, and if you haven’t heard of this concept at all, I advise you go and google “CQRS” and read what Greg Young and his cohort have to say about it. </p>  <p>I’m also a big fan of DDD, although I feel that it is not generally suited for incredibly simple projects like RavenGallery, I do maintain some of the programmatic consequences of utilising DDD are valuable, such as encapsulating as much behaviour as possible in my entities.</p>  <p>We will approach this discussion with the general acceptance that </p>  <ul>   <li>Behaviour in entities is a good&nbsp; thing, </li>    <li>Change should be enacted by the root aggregate of the entity relationship</li>    <li>One RavenDB document ~= one root aggregate</li>    <li>Entities themselves shouldn’t be used directly in view models</li>    <li>Change shouldn’t be enacted on entities by any other means than calling a method that specifies the intent of that change</li>    <li>It shouldn’t ideally be possible to construct entities in an invalid state</li> </ul>  <p>None of this is really under discussion, but the nature of the solution implemented definitely is, now let’s look at the options we have when treating RavenDB documents as aggregate roots in this scenario.</p>  <p>Let’s also step away from RavenGallery for a moment, and assume we are building a much larger, more complex system with a lot of business logic and a large team of developers with the typical range of ability you tend to find in typical software departments. As stated before, it is my intent for RavenGallery to not just be “<em>another project that cuts corners in order to demo one single piece of&nbsp; technology</em>”.</p>  <p><strong>Use the documents as entities and let all state be exposed via public getters/setters</strong></p>  <p>As I understand it, this is @ayende’s stance, and it was my initial direction too - I would have most likely gone for if I wasn’t doing this “as if I was working in a production environment”.</p>  <p>This system creates a few truths</p>  <ul>   <li>We can still perform LINQ queries on the documents when constructing the Views</li>    <li>Anybody <strong><em>can</em></strong> modify state, either from a command handler, service,factory or whatever so long as they have an entity</li>    <li>De-normalized state that is not necessary part of the entity gets exposed on the entity itself</li>    <li>Creating test data for the query layer is easy because we can set any data on the document</li> </ul>  <p>Technically, all this system needs is a well disciplined team who have been educated not to directly meddle with entities, but instead to always encapsulate behaviour in the entity. </p>  <p>The state that is being exposed on the entity that is not technically a part of that entity should not really ever be touched by domain logic if we work in this way.</p>  <p><strong>Use the documents as entities but hide all state behind public getters/private setters</strong></p>  <p>This is just a variation of the above, the only difference is that we prevent people from changing state from outside of the entity, I prefer this but it does mean creating test data is a bit tricky when testing the view layer (because we can’t construct the document whichever way we like)</p>  <ul>   <li>We can still perform LINQ queries on the documents when constructing the Views</li>    <li><strike>Anybody <strong><em>can</em></strong> modify state, either from a command handler, service,factory or whatever so long as they have an entity</strike></li>    <li>De-normalized state that is not necessary part of the entity gets exposed on the entity itself</li>    <li><strike>Creating test data for the query layer is easy because we can set any data on the document</strike></li> </ul>  <p>You win some, you lose some.</p>  <p><strong>Use the documents as entities, but hide all state in private fields with no public properties</strong></p>  <p>This is nice and pure, we can use a serializer that serializes private state, not expose any state directly</p>  <ul>   <li><strike>We can still perform LINQ queries on the documents when constructing the Views</strike></li>    <li><strike>Anybody <strong><em>can</em></strong> modify state, either from a command handler, service,factory or whatever so long as they have an entity</strike></li>    <li><strike>De-normalized state that is not necessary part of the entity gets exposed on the entity itself</strike></li>    <li><strike>Creating test data for the query layer is easy because we can set any data on the document</strike></li> </ul>  <p>Unfortunately by closing down the document/entity in this manner, we actually make it almost impossible to query the document store and get meaningful data back, unless we set all the fields to ‘stored’ and use projections for<em> every single view</em>.</p>  <p>Very pure, but on the whole quite hard to work with.</p>  <p><strong>Wrap the documents in the entities,&nbsp; expose behaviour on entities, allow view layer to go directly to the documents</strong></p>  <p>This is the controversial approach I went for, this gives us</p>  <ul>   <li>We can still perform LINQ queries on the documents when constructing the Views</li>    <li><strike>Anybody <strong><em>can</em></strong> modify state, either from a command handler, service,factory or whatever so long as they have an entity</strike>*</li>    <li><strike>De-normalized state that is not necessary part of the entity gets exposed on the entity itself</strike></li>    <li>Creating test data for the query layer is easy because we can set any data on the document</li> </ul>  <p><em><font size="1">*We are assuming here that Views in RavenDB are analogous to direct SQL access in NHibernate for generating views, theoretically they *could* modify state, but there is no reason for them to so it’s not likely to happen. The important point here is that the ‘write’ layer has no direct access to the data.</font></em></p>  <p>The major downside to this is that we start seeing a bit of seemingly superfluous ceremony in our repository when we come to create entities wrapped around the documents. The major up-shot is that it’s very pure, and still gives us a lot of options in the future for changing strategies with regards to how we store the data or retrieve views.</p>  <p><strong>Okay then, so which one do we go for?</strong></p>  <p>My personal opinion is the first one for simple projects that you know are going to remain simple, and the last one for projects that you know are going to get large and complex.</p>  <p>We make trade-offs by using a single data store for both storing the domain state, and for retrieving views of that data. It’s quite a good trade-off because we get really fast reads and really fast writes for free because RavenDB gives that to us, but it’s an awkward trade off because you can end up with a structure that doesn’t quite mesh with the behaviour that you want in your domain.</p>  <p><strong>Summary</strong></p>  <p>The full discussion can be found <a href="http://groups.google.com/group/ravendb/browse_thread/thread/6d7fd996ab031386/546372f3fae21ed4">here</a>, in the Google Groups, many thanks so far to those who have participated so far, I’ve had a number of people come out in favour of the wrapping approach, and a number of people come out in favour of exposing all state and just getting on with things.</p>  <p>The question at the end of the day seems to revolve around quite how anally retentive you can be over a simple design decision, I’m anal and I don’t mind a bit of ceremony, so sue me – I’m not going to say you’re wrong for opting for the more free and open approach – I only wish I was brave enough to.</p>  <p><strong>PS</strong></p>  <p>I’ll be reducing the ceremony once I know exactly how I use my objects, there are a number of options available to me, I’m just leaving it until I have a better grasp of what I need.</p>
	</div>
      <div id="links">
        <a href="/">Index</a>
        <a href="http://feed.codeofrob.com/RobAshton">Subscribe</a>
        <a href="http://twitter.com/robashton">Follow me</a>
      </div>
      <div id="disqus">
        <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'codeofrob'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
    </div>
    <div id="post-comments"><div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=7a1ec7b0fe2032dcdec98955465ad960&size=50&default=identicon"/>
<p>Olle</p></div>
<div class="comment-body">
<br/> 				Hi Rob. Great article and your RavenGallery project has been a really good introduction and inspiration for me and my Raven CQRS laboratory.I have one implementation question though that I hope you can give your point of view on.Lets say I have a command that I want to do a patch against Raven instead of the standard Execute (see below, taken from RavenGallery) behavior. public void Execute&lt;T&rt;(T command)        {            var handler = _container.GetInstance<ICommandHandler<T>>();            handler.Handle(command);            _documentSession.SaveChanges();        }I quess I could set a "bool IsPatch" on the ICommandHandler, and just skip the "_documentSession.SaveChanges();" if it's a patch. But I would really appreciate to hear your approach on this matter.
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=b6a6693f03003f7ab0f9b0882e9c2dde&size=50&default=identicon"/>
<p>robashton</p></div>
<div class="comment-body">
<br/> 				You'll always run into problems if you try to constrain your functionality to an elaborate "framework" or way of thinking. The command/etc approach works for the way I do things in this app, but if you want to do patches outside of Unit of Work then I'd probably just create a different handler/wrapper for this type of thing.Rather than forcing your commands to all suddenly implement a bool IsPatch consider the following perhaps[PatchCommand]public PatchHandler : ICommandHandler { }You can either check for this in the Execute method, or have something more elaborate evolve as you discover other items of meta-data that command handlers might wish to expose.Another option would be to just push the SaveChanges into the command handler itself, the russian doll model would work quite well hereTransactionalCommandHandler[T] : ICommandHandler[T]{        public TransactionalCommandHandler(IDocumentSession session, ICommandHandler[T] innerHandler){         }          public Handle(T command) {                   innerHandler.Handle(command)                   session.SaveChanges();          }Then the container we use to find the handlers can be set up to wrap up any command handler that doesn't have [NotUnitOfWork] with a transactional command handler.This is a nice way of adding functionality anyway, for example LoggingCommandHandler and TimingCommandHandlerThere is no right or wrong, this example I just gave might be an example of over-engineering if you weren't going to use any of it, if a simple IsPatch property will work for you then you should just do it. You can always refactor further down the line if you so choose.
				</div></div>
</div>
  </body>
</html>
