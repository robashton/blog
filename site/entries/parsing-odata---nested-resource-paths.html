<html>
  <head>
    <title id="title">Parsing OData - nested resource paths</title>
    <link rel="stylesheet" type="text/css" href="/style.css"></link>
    <link rel="stylesheet" type="text/css" href="/rainbow.css"></link>
    <link href='http://fonts.googleapis.com/css?family=Libre+Baskerville' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
    <link rel="alternate" type="application/atom+xml" href="http://feeds.feedblitz.com/robashton&x=1" title="Rob Ashton's blog" />
    <meta name="Description" content="Rob Ashton's blog and various other things. Javascript, C#, testing, whatever.">
    <script type="text/javascript" src="/jquery.js"></script>
    <script type="text/javascript" src="/post.js"></script>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-11207442-1']);
      _gaq.push(['_setDomainName', 'codeofrob.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </head>
  <body>
    <a class="subscribe" href="http://feed.codeofrob.com/RobAshton">Subscribe to my blog</a>
    <div id="blog-entry">
      <h1 id="post-title">Parsing OData - nested resource paths</h1>
      <h6>Published on <span class="date">2013-4-8</span></h6>
      <div id="post"><p>I&#39;m writing an OData parser in OMeta, and <a href="/entries/writing-an-odata-parser---starting-at-the-beginning.html">yesterday</a> I stopped with the realisation that I&#39;d have to deal with paths of resources, each with their own potential identifier.</p>
<p>First off, I come back to this code and look up the rules for Resource Names in OData as I left that hole open yesterday and it is an itch I want to scratch.</p>
<p>I read the <a href="http://www.odata.org/documentation/uri-conventions#ResourcePath">Uri conventions</a>, the <a href="http://www.odata.org/media/30002/OData%20ABNF.html">ABNF</a> and this leads me to <a href="http://www.rfc-editor.org/rfc/rfc3229.txt">RFC3229</a> and I fell asleep.</p>
<p>I&#39;ll see if this has been covered in Rulemotion&#39;s codebase when I get back into the office on Tuesday as I&#39;d prefer to do this properly.</p>
<p><strong>Recursing through resource paths</strong></p>
<p>Back to the matter at hand, I want to deal with arbitrary paths like so</p>
<pre><code><span class="regexp">/model(1)/children(1)/otherchildren(1)/</span>field</code></pre>
<p>This shouldn&#39;t be <em>too hard</em>, although I am practising Mojito-driven-development this weekend so it does tax the brain cells that are still functioning.</p>
<p>What I want to achieve:</p>
<ul>
<li>I want to be able to parse multiple resource paths separated by a &#39;/&#39;</li>
<li>I want to build up a model of this path (each with a name and a specified id)</li>
<li>I want to once this is done, carry on parsing the rest of the path</li>
</ul>
<p>Hmm, well simplest thing for this is to say that this is recursive and not change a thing at all about the initial expression</p>
<pre><code><span class="constant">OData</span> = (
  (
    <span class="constant">PathSegment</span><span class="symbol">:model</span> -&gt; model
  )
  | <span class="string">'/'</span>
) 


<span class="constant">PathSegment</span> = 
      <span class="string">'/'</span>
      <span class="constant">ResourceName</span><span class="symbol">:resource</span>
      (
        (<span class="string">"("</span> <span class="constant">Number</span><span class="symbol">:key</span> <span class="string">")"</span>)?
        (<span class="constant">PathSegment</span><span class="symbol">:</span> <span class="keyword">next</span>)?
      ) -&gt; { <span class="symbol">resource:</span> resource, <span class="symbol">key:</span> key, <span class="symbol">next:</span> <span class="keyword">next</span> }
    ,</code></pre>
<p>All we do here is say </p>
<ul>
<li>We expect a forward-slash, followed by the name of the addressed resource</li>
<li>We then optionally expect a specified Id for that resource</li>
<li>We then optionally expect another part of the path component</li>
</ul>
<p>In this way, we&#39;ll recursively build up the path to the addressed resource in the model and end up being able to follow this down when working out what to do with our OData request.</p>
<p><strong>Links</strong></p>
<p>There is another part to this, which is that rather than addressing paths, we can address links, which are expressed similarly:</p>
<pre><code>/model(1)/<span class="variable">$links</span>/children</code></pre>
<p>This can actually be dealt with in very much the same way:</p>
<pre><code>PathSegment = 
      <span class="string">'/'</span>
      ResourceName:resource
      (
        (<span class="string">"("</span> Number:key <span class="string">")"</span>)?
        (
          (se<span class="string">q("/<span class="variable">$links</span>")</span> PathSegment:<span class="keyword">link</span>)
        | PathSegment: <span class="keyword">next</span>
        )?
      ) -&gt; { resource: resource, key: key, <span class="keyword">link</span>: <span class="keyword">link</span>, property: <span class="keyword">next</span> }
    ,</code></pre>
<ul>
<li>We expect a forward-slash, followed by the name of the addressed resource</li>
<li>We then optionally expect a specified Id for that resource</li>
<li>We then expect a sequence of characters (/$links) followed by another path segment</li>
<li>OR we expect another path segment</li>
<li>But the above two are optional</li>
</ul>
<p>The model is then built up recursively.</p>
<p>I think that actually I shouldn&#39;t be allowing further addressing once we&#39;ve followed a link - but I&#39;m not so sure about that so I&#39;ll ask when I get back into the office.</p>
</div>
      <div id="links">
        <a href="/">Index</a>
        <a href="http://feed.codeofrob.com/RobAshton">Subscribe</a>
        <a href="http://twitter.com/robashton">Follow me</a>
      </div>
      <div id="hire-me">
        <h6>Why not hire me?</h6>
        <p>I am available for emergency consults, workshops, training and short-term development work anywhere in Europe</p>
        <p>C#, JavaScript, Clojure, RavenDB, NodeJS, Architecture review.. etc</p>
        <p><a href="mailto:robashton@codeofrob.com">Get in touch</a></p>
      </div>
      <div id="disqus">
        <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'codeofrob'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
    </div>
    <div id="post-comments">

    </div>
  </body>
</html>
