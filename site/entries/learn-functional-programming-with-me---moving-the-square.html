<html>
  <head>
    <title id="title">Learn Functional Programming With Me - Moving The Square</title>
    <link rel="stylesheet" type="text/css" href="/style.css"></link>
    <link href='http://fonts.googleapis.com/css?family=Libre+Baskerville' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
    <link rel="alternate" type="application/atom+xml" href="http://feeds.feedblitz.com/robashton&x=1" title="Rob Ashton's blog" />
    <meta name="Description" content="Rob Ashton's blog and various other things. Javascript, C#, testing, whatever.">
    <script type="text/javascript" src="/jquery.js"></script>
    <script type="text/javascript" src="/post.js"></script>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-11207442-1']);
      _gaq.push(['_setDomainName', 'codeofrob.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </head>
  <body>
    <a class="subscribe" href="http://feed.codeofrob.com/RobAshton">Subscribe to my blog</a>
    <div id="blog-entry">
      <h1 id="post-title">Learn Functional Programming With Me - Moving The Square</h1>
      <h6>Published on <span class="date">2012-6-13</span></h6>
      <div id="post"><p>So, last session I managed to get a square being drawn, as if I haven't done that a thousand times in JS - now to do something a bit more dangerous (because it involves state), and more likely to get me in trouble - let's move the square around using the keyboard.</p>

<p><strong>Reminder</strong>: The source for all of this can be found at <a href="https://github.com/robashton/clojure-spaceinvaders">github.com/robashton/clojure-spaceinvaders</a></p>

<h2>Parameterising the function</h2>

<p>This is a no-brainer, I'm going to need to know where to draw this thing, I start off by passing in the state required to draw a rect to my function.</p>

<pre><code>(defn drawRect [x y w h]
  (let [target (.getElementById js/document "target")
        context (.getContext target "2d")]
     (.fillRect context x y w h)           
  )
)
</code></pre>

<p>So far so good - but now I'm going to need to not only pass in those variables, but - well they're going to have to be variable (somehow) because they're going to have to change each frame and it's stuff like this that makes me break out in a cold sweat because I haven't discovered the patterns to solve this type of problem yet.</p>

<p>Let's explain - you see that 'let' statement, the values I've defined there, those key value pairs are <em>immutable</em>, this means I cannot change them - for example, if I want to make this square move of its own voilition, the literal equivalent of</p>

<pre><code>for(var x = 0; x &lt; 1000; x++)
  drawRect(x, 0, 100, 100);
</code></pre>

<p>Doesn't exist.</p>

<p>Now, if I were to make my best guess at how to solve this, I'd say that we need a function that takes in x, and then calls itself with x+1, for example at a conceptual level:</p>

<pre><code>function drawAndMove(x) {
  drawRect(x, 0, 100, 100)
  if(x &lt;= 1000)
    drawAndMove(x+1)
}
drawAndMove(0);
</code></pre>

<p>This actually maps across to a construct in our chosen world that looks something like the following:</p>

<pre><code>(loop [x 0]
  (drawRect x 0 100 100)     
  (if (&lt;= x 1000)
    (recur (inc x))
  )
)
</code></pre>

<ul>
<li>I want to loop, I want the following values available in this loop (x = 0)</li>
<li>Please draw the rect at x,0,100,100</li>
<li>If x &lt;= 1000, recurse and increment x</li>
</ul>

<p>Okay, this is a bit crazy and verbose - perhaps there is a better more shorthand way of doing this (anybody care to chip in around now?), but Imma press ahead and say that actually, that is not the greatest loop of all time.</p>

<p>We actually have to yield to the UI thread each 'frame' which blows this whole thing out of the water - that's not to say that this code isn't functional - because I love having a row of black drawn over my canvas on the UI thread with no user interaction whatsoever - but we actually need something like the following</p>

<pre><code>function tick() {
  logic();
  render();
  setTimeout(tick, 33);
}
</code></pre>

<p>Again, cutting a corner here because I don't want to write a full on game loop in clojure just yet.</p>

<p>Figuring it out, I've ended up with something like this</p>

<pre><code>(defn tick [x]
  (drawRect x 0 100 100)
  (if (&lt;= x 1000)
    (js/setTimeout (fn []
       (tick (inc x))
    ) 33  )
  )
)


(defn ^:export init []
   (tick 0)
)
</code></pre>

<ul>
<li>Define a function called tick, which takes in the current position of our object</li>
<li>Draw a rect at that location</li>
<li>If x is still less than 1000, then</li>
<li>In 33 milliseconds, call tick again but with x+1</li>
</ul>

<p>I've actually gone far enough for a single blog entry at this point so I'll leave keyboard input till another day - I have some thoughts about this work so far however:</p>

<ul>
<li>That setTimeout doo-hick is taking in an anonymous function, am I creating this function every frame? I wouldn't do that in most of my JS, it's effectively the same as creating a closure in a loop - not good?</li>
<li>I saw something like this that used global state and an atom, and then tick could be called with no parameters - is this a better solution? It seems somewhat against what functional programming is about</li>
<li>Thoughts?</li>
</ul></div>
      <div id="links">
        <a href="/">Index</a>
        <a href="http://feed.codeofrob.com/RobAshton">Subscribe</a>
        <a href="http://twitter.com/robashton">Follow me</a>
      </div>
      <div id="disqus">
        <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'codeofrob'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
    </div>
    <div id="post-comments">

    </div>
  </body>
</html>
