<!doctype html> <!--[if ie 7]> <html lang="en" class="ie7"> <![endif]-->
<!--[if ie 8]> <html lang="en" class="ie8"> <![endif]-->
<!--[if ie 9]> <html lang="en" class="ie9"> <![endif]-->
<!--[if !ie]><!-->
<html lang="en"> <!--<![endif]-->
<head>
    <title id="title">The client API for my clojure document database</title>
    <meta charset="utf-8">
    <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="Description" content="Rob Ashton's blog and various other things. Javascript, C#, testing, whatever.">
    <meta name="author" content="">
    <link rel="alternate" type="application/atom+xml" href="http://feed.codeofrob.com/RobAshton" title="Rob Ashton's blog" />
    <link rel="stylesheet" href="/assets/plugins/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/headers/header1.css">
    <link rel="stylesheet" href="/assets/plugins/bootstrap/css/bootstrap-responsive.min.css">
    <link rel="stylesheet" href="/assets/css/style_responsive.css">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/assets/plugins/font-awesome/css/font-awesome.css">
    <link rel="stylesheet" href="/assets/css/themes/default.css">
    <link rel="stylesheet" type="text/css" href="/style.css"></link>
    <link rel="stylesheet" type="text/css" href="/rainbow.css"></link>
    <script type="text/javascript" src="/assets/js/jquery-1.8.2.min.js"></script>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-11207442-1']);
      _gaq.push(['_setDomainName', 'codeofrob.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>

  <body>
    <div class="header">
        <div class="container">
            <div class="logo">
             <h2><a href="/index.html">Rob Ashton</a></h2>
            </div>
            <div class="navbar">
                <div class="navbar-inner">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                      <span class="icon-bar"></span>
                      <span class="icon-bar"></span>
                      <span class="icon-bar"></span>
                    </a>
                    <div class="nav-collapse collapse">
                        <ul class="nav top-2">
                          <li>
                                <a href="/">Home</a>
                            </li>
                            <li>
                                <a href="/blog.html">Blog</a>
                            </li>
                            <li>
                                <a href="/testimonials.html">Testimonials</a>
                            </li>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <body>
    <div id="blog-entry">
      <h1 id="post-title">The client API for my clojure document database</h1>
      <h6>Published on <span class="date">2014-5-1</span></h6>
      <div id="post"><p>Let&#39;s start our little foray into seeing what code I cooked up by looking at how I did the Client API for CravenDB as it&#39;ll give us a good indication as to the sort of features I wanted to support.</p>
<ul>
<li><a href="/entries/i-wrote-a-document-database-in-clojure.html">I wrote a document database in Clojure</a></li>
</ul>
<p>Just like RavenDB I decided that I wanted the same interface for talking to the database regardless of whether I was using a remote database over HTTP, an embedded database, or an in-memory database for testing.</p>
<p>For this, it seems that protocols are the best option we have in Clojure as it&#39;s essentially what they&#39;re for. This also gives me a convenient place to shove documentation and surface the Official Public API.</p>
<p>So I ended up with <a href="https://github.com/robashton/cravendb/blob/80314f64f25ff4af8906e7d3117cec9566d80ed0/src/cravendb/database.clj">this</a>, also listed below without the documentation for brevity.</p>
<pre><code><span class="list">(<span class="title">ns</span><span class="body"> cravendb.database)</span></span>

<span class="list">(<span class="title">defprotocol</span><span class="body"> DocumentDatabase
  <span class="list">(<span class="title">close</span><span class="body"> [this])</span></span>
  <span class="list">(<span class="title">load-document-metadata</span><span class="body"> [this id])</span></span>
  <span class="list">(<span class="title">query</span><span class="body"> [this opts])</span></span>
  <span class="list">(<span class="title">clear-conflicts</span><span class="body"> [this id])</span></span>
  <span class="list">(<span class="title">conflicts</span><span class="body"> [this])</span></span>
  <span class="list">(<span class="title">put-document</span><span class="body"> [this id document metadata])</span></span>
  <span class="list">(<span class="title">load-document</span><span class="body"> [this id])</span></span>
  <span class="list">(<span class="title">delete-document</span><span class="body"> [this id metadata])</span></span>
  <span class="list">(<span class="title">bulk</span><span class="body"> [this operations])</span></span>
  <span class="list">(<span class="title">put-index</span><span class="body"> [this index])</span></span>
  <span class="list">(<span class="title">load-index-metadata</span><span class="body"> [this id])</span></span>
  <span class="list">(<span class="title">delete-index</span><span class="body"> [this id])</span></span>
  <span class="list">(<span class="title">load-index</span><span class="body"> [this id])</span></span>)</span></span></code></pre><p>This is a low level interface obviously, the key operations being</p>
<ul>
<li>put-document</li>
<li>load-document</li>
<li>delete-document</li>
<li>query</li>
</ul>
<p>The great thing about this low level interface is that I can make various implementations of it, and then pass a &quot;database&quot; around without worrying what it is actually behind that.</p>
<p>So we have the ability to do</p>
<pre><code><span class="comment">; In-memory</span>
<span class="list">(<span class="title">def</span><span class="body"> instance <span class="list">(<span class="title">embedded/create</span><span class="body">)</span></span>)</span></span>
<span class="comment">; Embedded on disk</span>
<span class="list">(<span class="title">def</span><span class="body"> instance <span class="list">(<span class="title">embedded/create</span><span class="body"> <span class="string">"var/db"</span>)</span></span>)</span></span>
<span class="comment">; Remote via HTTP</span>
<span class="list">(<span class="title">def</span><span class="body"> instance <span class="list">(<span class="title">remote/create</span><span class="body"> <span class="string">"http://example.host:8000"</span>)</span></span>)</span></span></code></pre><p>And then each of those implementations supports the above operations transparently.</p>
<p>I wanted to support transactions with this database too, so a <em>bulk</em> operation is supported which is just a combination of the above operations.</p>
<pre><code><span class="list">(<span class="title">-&gt;</span><span class="body"> <span class="list">(<span class="title">t/open</span><span class="body"> instance)</span></span>
    <span class="list">(<span class="title">t/store</span><span class="body"> <span class="string">"doc-1"</span> { <span class="keyword">:message</span> <span class="string">"hello world"</span> })</span></span>
    <span class="list">(<span class="title">t/store</span><span class="body"> <span class="string">"doc-2"</span> { <span class="keyword">:message</span> <span class="string">"hello alice"</span> })</span></span>
    <span class="list">(<span class="title">t/store</span><span class="body"> <span class="string">"doc-3"</span> { <span class="keyword">:message</span> <span class="string">"hello bob"</span> })</span></span>
    <span class="list">(<span class="title">t/delete</span><span class="body"> <span class="string">"doc-4"</span>)</span></span>
    <span class="list">(<span class="title">t/commit</span><span class="body">!)</span></span></code></pre><p>I only have two implementations of this and they&#39;re actually pretty empty because they merely farm out into the code that really does something.</p>
<h3 id="the-remote-implementation">The remote implementation</h3>
<p>I ended up using a couple of packages from Clojars to do the hard work for me here</p>
<ul>
<li>*<a href="https://github.com/neotyk/http.async.client">http.async.client</a>*: This was an arbitrary choice, I just wanted a HTTP client that worked and supported async</li>
<li>*<a href="https://github.com/cemerick/url">cemerick.url</a>*: I&#39;m only using this for url encoding, but it seemed more sensible than trying to use the Java ones</li>
</ul>
<p>I have some pretty hideous functions for building URLs, I wrote these before I brought the URL library in, I could/should/would have changed them to use it.</p>
<pre><code><span class="list">(<span class="title">defn</span><span class="body"> url-for-doc-id [url id]
  <span class="list">(<span class="title">str</span><span class="body"> url <span class="string">"/document/"</span> id)</span></span>)</span></span>
<span class="list">(<span class="title">defn</span><span class="body"> url-for-index-id [url id]
  <span class="list">(<span class="title">str</span><span class="body"> url <span class="string">"/index/"</span> id)</span></span>)</span></span>
<span class="list">(<span class="title">defn</span><span class="body"> url-for-bulk-ops [url]
  <span class="list">(<span class="title">str</span><span class="body"> url <span class="string">"/bulk"</span>)</span></span>)</span></span>
<span class="list">(<span class="title">defn</span><span class="body"> url-for-conflicts [url]
  <span class="list">(<span class="title">str</span><span class="body"> url <span class="string">"/conflicts"</span>)</span></span>)</span></span>
<span class="list">(<span class="title">defn</span><span class="body"> url-for-conflict-id [url id]
  <span class="list">(<span class="title">str</span><span class="body"> url <span class="string">"/conflict/"</span> id)</span></span>)</span></span>
<span class="list">(<span class="title">defn</span><span class="body"> url-for-stream [url synctag]
  <span class="list">(<span class="title">str</span><span class="body"> url <span class="string">"/stream?synctag="</span> <span class="list">(<span class="title">or</span><span class="body"> synctag <span class="string">""</span>)</span></span>)</span></span>)</span></span></code></pre><p>An actual operation in the record (others removed for brevity)</p>
<pre><code><span class="list">(<span class="title">defrecord</span><span class="body"> RemoteDatabase [url]
  DocumentDatabase
  <span class="list">(<span class="title">close</span><span class="body"> [this])</span></span>

  <span class="list">(<span class="title">query</span><span class="body"> [this opts]
    <span class="list">(<span class="title">with-open</span><span class="body"> [client <span class="list">(<span class="title">http/create-client</span><span class="body">)</span></span>]
      <span class="list">(<span class="title">force-into-list</span><span class="body">
        <span class="list">(<span class="title">process-response</span><span class="body">
          <span class="list">(<span class="title">http/GET</span><span class="body"> client <span class="list">(<span class="title">url-for-query</span><span class="body"> url opts)</span></span>
                    <span class="keyword">:headers</span> default-headers
                    <span class="keyword">:query</span> <span class="list">(<span class="title">dissoc</span><span class="body"> opts <span class="keyword">:filter</span> <span class="keyword">:index</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre><p>I really like the brevity of Clojure for this. The &quot;close&quot; isn&#39;t really needed for this implementation so it&#39;s an empty function that returns nothing. The rest of the operations look the same, a http request and the processing of that http request. Lovely.</p>
<h3 id="the-embedded-implementation">The embedded implementation</h3>
<p>The embedded implementation is obviously the heart and soul of the whole database, everything comes through this (it sits behind the HTTP interface we&#39;ll see in the next post).</p>
<pre><code><span class="list">(<span class="title">defrecord</span><span class="body"> EmbeddedDatabase [storage index-engine ifh counters]</code></pre><p>The constructor for this record takes in the underlying storage engine, index engine, the in-flight transaction system and some performance counters. This wasn&#39;t really what I had in mind when I through it together, but the <a href="https://github.com/robashton/cravendb/blob/master/src/cravendb/embedded.clj#L24">code itself</a> is quite concise as it mostly just farms out the work to modules responsible for managing document operations, indexing operations and etc.</p>
<p>For example</p>
<pre><code><span class="list">(<span class="title">put-index</span><span class="body"> [this index]
  <span class="list">(<span class="title">with-open</span><span class="body"> [tx <span class="list">(<span class="title">s/ensure-transaction</span><span class="body"> storage)</span></span>]
    <span class="list">(<span class="title">s/commit</span><span class="body">! <span class="list">(<span class="title">indexes/put-index</span><span class="body"> tx index {<span class="keyword">:synctag</span> <span class="list">(<span class="title">s/next-synctag</span><span class="body"> tx)</span></span>})</span></span>)</span></span>)</span></span>
  <span class="list">(<span class="title">ie/notify-of-new-index</span><span class="body"> index-engine index)</span></span>)</span></span></code></pre><p>In this case (and most of the other cases), the code sitting in the record is just coordinating the actions between a few different modules.</p>
<h3 id="lessons-learned-about-protocols-and-records">Lessons learned about Protocols and Records</h3>
<p>It seems from this (and it carries across into other places I&#39;ve used protocols too). I tend to end up using a protocol for the polymorphism and the records to hold some handles/state and then delegate the work out into pure functions.</p>
<p>I could probably have used multi-methods for this (based on some property in the state), but I found them to be a bit messy because it meant bundling several implementations in the same file. I quickly moved away from the attempts where I did this when it got hard to follow.</p>
<p>Apparently protocols are also faster, but given performance was not really one of my goals I doubt that is a bottleneck in the database.</p>
</div>
      <div id="links">
        <a href="/">Index</a>
        <a href="http://feed.codeofrob.com/RobAshton">Subscribe</a>
        <a href="mailto:robashton@codeofrob.com">Respond</a>
      </div>

        <!--=== Copyright ===-->
          <div class="container">
            <div class="row-fluid">
              <div class="span6">
                <p class="terms">2018 © Rob Ashton. ALL Rights Reserved.</p>
              </div>
            </div><!--/row-fluid-->
          </div><!--/container-->

        <!-- JS Global Compulsory -->
        <script type="text/javascript" src="/assets/js/modernizr.custom.js"></script>
        <script type="text/javascript" src="/assets/plugins/bootstrap/js/bootstrap.min.js"></script>
        <!-- JS Implementing Plugins -->
        <script type="text/javascript" src="/assets/plugins/flexslider/jquery.flexslider-min.js"></script>
        <script type="text/javascript" src="/assets/plugins/parallax-slider/js/modernizr.js"></script>
        <script type="text/javascript" src="/assets/plugins/parallax-slider/js/jquery.cslider.js"></script>
        <script type="text/javascript" src="/assets/plugins/back-to-top.js"></script>
        <script type="text/javascript" src="/assets/plugins/jquery.sticky.js"></script>
        <script type="text/javascript" src="/assets/plugins/fancybox/source/jquery.fancybox.pack.js"></script>
        <!-- JS Page Level -->
        <script type="text/javascript" src="/assets/js/app.js"></script>
        <script type="text/javascript" src="/assets/js/pages/index.js"></script>
        <script type="text/javascript">
jQuery(document).ready(function() {
    App.init();
    App.initFancybox();
    App.initSliders();
    Index.initParallaxSlider();
    });
        </script>
        <!--[if lt IE 9]>
    <script src="assets/js/respond.js"></script>
<![endif]-->
        </body>
        </html>

