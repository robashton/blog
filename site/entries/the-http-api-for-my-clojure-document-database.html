<!doctype html> <!--[if ie 7]> <html lang="en" class="ie7"> <![endif]-->
<!--[if ie 8]> <html lang="en" class="ie8"> <![endif]-->
<!--[if ie 9]> <html lang="en" class="ie9"> <![endif]-->
<!--[if !ie]><!-->
<html lang="en"> <!--<![endif]-->
<head>
    <title id="title">The http API for my clojure document database</title>
    <meta charset="utf-8">
    <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="Description" content="Rob Ashton's blog and various other things. Javascript, C#, testing, whatever.">
    <meta name="author" content="">
    <link rel="alternate" type="application/atom+xml" href="http://feed.codeofrob.com/RobAshton" title="Rob Ashton's blog" />
    <link rel="stylesheet" href="/assets/plugins/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/headers/header1.css">
    <link rel="stylesheet" href="/assets/plugins/bootstrap/css/bootstrap-responsive.min.css">
    <link rel="stylesheet" href="/assets/css/style_responsive.css">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/assets/plugins/font-awesome/css/font-awesome.css">
    <link rel="stylesheet" href="/assets/css/themes/default.css">
    <link rel="stylesheet" type="text/css" href="/style.css"></link>
    <link rel="stylesheet" type="text/css" href="/rainbow.css"></link>
    <script type="text/javascript" src="/assets/js/jquery-1.8.2.min.js"></script>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-11207442-1']);
      _gaq.push(['_setDomainName', 'codeofrob.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>

  <body>
    <div class="header">
        <div class="container">
            <div class="logo">
             <h2><a href="/index.html">Rob Ashton</a></h2>
            </div>
            <div class="navbar">
                <div class="navbar-inner">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                      <span class="icon-bar"></span>
                      <span class="icon-bar"></span>
                      <span class="icon-bar"></span>
                    </a>
                    <div class="nav-collapse collapse">
                        <ul class="nav top-2">
                          <li>
                                <a href="/">Home</a>
                            </li>
                            <li>
                                <a href="/blog.html">Blog</a>
                            </li>
                            <li>
                                <a href="/statements.html">Testimonials</a>
                            </li>
                            <li>
                                <a href="/hire.html">Hire Me</a>
                            </li>
                    </div>
                </div>
            </div>
        </div>
    </div>

  <body>
    <div id="blog-entry">
      <h1 id="post-title">The http API for my clojure document database</h1>
      <h6>Published on <span class="date">2014-5-27</span></h6>
      <div id="post"><p>I mentioned in the last post that I had decided on a common set of protocols for a client wishing to talk to the database, regardless of whether it was in-memory, remote or on embedded on disk.</p>
<ul>
<li><a href="/entries/i-wrote-a-document-database-in-clojure.html">I wrote a document database in Clojure</a></li>
<li><a href="/entries/the-client-api-for-my-clojure-document-database.html">The Client API for my Clojure document database</a></li>
</ul>
<p><strong>Recap</strong></p>
<p>This took the form of a protocol that looked like this:</p>
<pre><code><span class="list">(<span class="title">defprotocol</span><span class="body"> DocumentDatabase
  <span class="list">(<span class="title">close</span><span class="body"> [this])</span></span>
  <span class="list">(<span class="title">load-document-metadata</span><span class="body"> [this id])</span></span>
  <span class="list">(<span class="title">query</span><span class="body"> [this opts])</span></span>
  <span class="list">(<span class="title">clear-conflicts</span><span class="body"> [this id])</span></span>
  <span class="list">(<span class="title">conflicts</span><span class="body"> [this])</span></span>
  <span class="list">(<span class="title">put-document</span><span class="body"> [this id document metadata])</span></span>
  <span class="list">(<span class="title">load-document</span><span class="body"> [this id])</span></span>
  <span class="list">(<span class="title">delete-document</span><span class="body"> [this id metadata])</span></span>
  <span class="list">(<span class="title">bulk</span><span class="body"> [this operations])</span></span>
  <span class="list">(<span class="title">put-index</span><span class="body"> [this index])</span></span>
  <span class="list">(<span class="title">load-index-metadata</span><span class="body"> [this id])</span></span>
  <span class="list">(<span class="title">delete-index</span><span class="body"> [this id])</span></span>
  <span class="list">(<span class="title">load-index</span><span class="body"> [this id])</span></span>)</span></span></code></pre>
<p>It&#39;s fairly well established that document database operations map well into a restful interface - in the above mappings we only have two resources,</p>
<ul>
<li>/document (PUT/GET/DELETE/HEAD)</li>
<li>/index    (PUT/GET/DELETE/HEAD)</li>
</ul>
<p>With a convenience &quot;bulk&quot; endpoint which we&#39;d use if we wanted to do multiple operations in a single transaction.</p>
<p><strong>Enter Liberator</strong></p>
<p>It just so happens that there is a great library available for Clojure (built on top of some other decisions (ring) made by the clojure community) which enforces valid http over the notion of resources. This library is called &quot;<a href="http://clojure-liberator.github.io/liberator/">Liberator</a>&quot;</p>
<p>You can describe a resource and it&#39;ll manage all the appropriate HTTP operations for you:</p>
<pre><code>(resource
  <span class="symbol">:allowed-methods</span> [<span class="symbol">:put</span> <span class="symbol">:get</span> <span class="symbol">:delete</span> <span class="symbol">:head</span>]
  <span class="symbol">:put!</span> some-handler
  <span class="symbol">:delete!</span> some-handler
  <span class="symbol">:handle-ok</span> some-handler)</code></pre>
<p><strong>And HTTP-Kit</strong></p>
<p>By itself, liberator isn&#39;t really enough to talk to the world over HTTP, as you need a http server to actually host it.</p>
<p>I used HTTP Kit because it supports asynchronous operations and seems to be getting the love these days. What this means, is you create some handlers using liberator and pass them into the &#39;run-server&#39; function from http-kit.</p>
<pre><code><span class="list">(<span class="title">run-server</span><span class="body"> handlers)</span></span></code></pre>
<p><strong>So I have an embedded database</strong></p>
<p>I don&#39;t want these routes I&#39;ve defined to be coupled to either</p>
<ul>
<li>The HTTP server hosting them (http-kit in this case)</li>
<li>The type of database being used (in-memory or otherwise)</li>
</ul>
<p>So what I did is created a closure, which takes in the instance of database to talk to and returns the routes defined around that instance</p>
<pre><code><span class="list">(<span class="title">defn</span><span class="body"> create-http-server [instance]
  <span class="list">(<span class="title">let</span><span class="body"> [db-routes <span class="list">(<span class="title">create-routes</span><span class="body"> instance)</span></span>]
    <span class="list">(<span class="title">handler/api</span><span class="body"> db-routes)</span></span>)</span></span>)</span></span></code></pre>
<p>I can then use that in tests, the REPL or the main application to create a http server around an instance of a database</p>
<p>This is what my main application looks like for example.</p>
<pre><code>(run-server
  (http/<span class="operator"><span class="keyword">create</span>-http-server embedded-instance) { :port <span class="number">8001</span> :<span class="keyword">join</span>? <span class="keyword">true</span> }))</code></pre>
<p><strong>The routes themselves</strong></p>
<pre><code><span class="list">(<span class="title">defn</span><span class="body"> create-routes [instance]
  <span class="list">(<span class="title">routes</span><span class="body">
    <span class="list">(<span class="title">ANY</span><span class="body"> <span class="string">"/document/:id"</span> [id]
      <span class="list">(<span class="title">resource</span><span class="body">
        <span class="keyword">:allowed-methods</span> [<span class="keyword">:put</span> <span class="keyword">:get</span> <span class="keyword">:delete</span> <span class="keyword">:head</span>]
        <span class="keyword">:exists</span>? <span class="list">(<span class="title">fn</span><span class="body"> [ctx] <span class="list">(<span class="title">resource-exists</span><span class="body">
                            ctx
                            #<span class="list">(<span class="title">db/load-document</span><span class="body"> instance id)</span></span>
                            #<span class="list">(<span class="title">db/load-document-metadata</span><span class="body"> instance id)</span></span>)</span></span>)</span></span>
        <span class="keyword">:available-media-types</span> accepted-types
        <span class="keyword">:etag</span> <span class="list">(<span class="title">fn</span><span class="body"> [ctx] <span class="list">(<span class="title">etag-from-metadata</span><span class="body"> ctx)</span></span>)</span></span>
        <span class="keyword">:put</span>! <span class="list">(<span class="title">fn</span><span class="body"> [ctx] <span class="list">(<span class="title">db/put-document</span><span class="body"> instance id <span class="list">(<span class="title">read-body</span><span class="body"> ctx)</span></span> <span class="list">(<span class="title">read-metadata</span><span class="body"> ctx)</span></span>)</span></span>)</span></span>
        <span class="keyword">:delete</span>! <span class="list">(<span class="title">fn</span><span class="body"> [_] <span class="list">(<span class="title">db/delete-document</span><span class="body"> instance id <span class="list">(<span class="title">read-metadata</span><span class="body"> _)</span></span>)</span></span>)</span></span>
        <span class="keyword">:handle-ok</span> <span class="list">(<span class="title">fn</span><span class="body"> [_] <span class="list">(<span class="title">standard-response</span><span class="body"> _ <span class="list">(<span class="body">:<span class="keyword">:resource</span> _)</span></span> <span class="list">(<span class="body">:<span class="keyword">:metadata</span> _)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>
    <span class="list">(<span class="title">ANY</span><span class="body"> <span class="string">"/index/:id"</span> [id]
      <span class="list">(<span class="title">resource</span><span class="body">
        <span class="keyword">:allowed-methods</span> [<span class="keyword">:put</span> <span class="keyword">:get</span> <span class="keyword">:delete</span> <span class="keyword">:head</span>]
        <span class="keyword">:exists</span>? <span class="list">(<span class="title">fn</span><span class="body"> [ctx] <span class="list">(<span class="title">resource-exists</span><span class="body">
                            ctx
                            #<span class="list">(<span class="title">db/load-index</span><span class="body"> instance id)</span></span>
                            #<span class="list">(<span class="title">db/load-index-metadata</span><span class="body"> instance id)</span></span>)</span></span>)</span></span>
        <span class="keyword">:available-media-types</span> accepted-types
        <span class="keyword">:etag</span> <span class="list">(<span class="title">fn</span><span class="body"> [ctx] <span class="list">(<span class="title">etag-from-metadata</span><span class="body"> ctx)</span></span>)</span></span>
        <span class="keyword">:put</span>! <span class="list">(<span class="title">fn</span><span class="body"> [ctx] <span class="list">(<span class="title">db/put-index</span><span class="body"> instance <span class="list">(<span class="title">merge</span><span class="body"> { <span class="keyword">:id</span> id } <span class="list">(<span class="title">read-body</span><span class="body"> ctx)</span></span>)</span></span>)</span></span>)</span></span>
        <span class="keyword">:delete</span>! <span class="list">(<span class="title">fn</span><span class="body"> [_] <span class="list">(<span class="title">db/delete-index</span><span class="body"> instance id)</span></span>)</span></span>
        <span class="keyword">:handle-ok</span> <span class="list">(<span class="title">fn</span><span class="body"> [_] <span class="list">(<span class="title">standard-response</span><span class="body"> _ <span class="list">(<span class="body">:<span class="keyword">:resource</span> _)</span></span> <span class="list">(<span class="body">:<span class="keyword">:metadata</span> _)</span></span> )</span></span> )</span></span>)</span></span>)</span></span>

    <span class="comment">;; ETC ETC ETC ETC</span></code></pre>
<p>They&#39;re a bit more complicated than any demo because</p>
<ul>
<li>The database support Etags for versioning</li>
<li>An exists? check is needed and we cache the results</li>
<li>The database will return json/edn/html depending on the requester (standard-response)</li>
</ul>
<p>Other than that, the routes are just a wrapper around the db operations already described in the previous entry.</p>
<p><strong>What did we learn</strong></p>
<p>Liberator is a really tidy way of wrapping up something and exposing it over HTTP, and that we can pick and choose HTTP servers to go with this is the icing on the cake. This is something I liked about this eco-system for sure. (See &#39;connect&#39; in node or &#39;OWIN&#39; in .NET)</p>
<p>Next up, we&#39;ll look at the core storage protocols in the document database and how that helped me write different storage mechanisms.</p>
<p><strong>Related Files</strong></p>
<ul>
<li>http.clj</li>
<li>database.clj</li>
</ul>
</div>
      <div id="links">
        <a href="/">Index</a>
        <a href="http://feed.codeofrob.com/RobAshton">Subscribe</a>
        <a href="http://twitter.com/robashton">Follow me</a>
      </div>
      <div id="hire-me">
        <h6>This used to ask if you wanted to hire me</h6>
        <p>But chances are I'm not available, as I'm busy shipping stuff.</p>
        <p>I am available for conference speaking, I like talking and will do so for just T&E (and perhaps a bottle of wine or two).</p>
        <p>I have done soft keynotes, and usually entertain/rile people in equal proportion, but prefer to talk tech as that's what I do</p>
        <p><a href="mailto:robashton@codeofrob.com">Email me :)</a></p>
      </div>
      <div id="disqus">
        <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'codeofrob'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
    </div>
    <div id="post-comments">

    </div>

<div class="footer" style="margin-top: 0px">
    <div class="container">
        <div class="row-fluid">
            <div class="span3">
                <div class="headline"><h3>Get In Touch</h3></div>
                <address class="address">
                    <ul class="icons-ul">
                        <li><i class="icon-li icon-envelope"></i>Email: <a href="mailto:robashton@codeofrob.com" class="">robashton@codeofrob.com</a></li>
                        <li><i class="icon-li icon-envelope"></i>Skype: <a href="skype:rob_ashton" class="">rob_ashton</a></li>
                    </ul>
                </address>
            </div><!--/span3-->
            <div class="span5">
                <div class="headline"><h3>Subscribe</h3></div>
                <p>I publish an <a href="http://feed.codeofrob.com/RobAshton">RSS feed</a> from my blog and some other activities</p>
            </div>
            <div class="span4">
                <div class="posts">
                  <div class="headline"><h3>Find me...</h3></div>
                  <p><a href="http://twitter.com/robashton"><img src="/assets/img/twitter.jpg" alt="" />
                  <a href="http://github.com/robashton"><img src="/assets/img/github.png" alt="" /></a></p>
                </div>
            </div><!--/span4-->
        </div><!--/row-fluid-->
    </div><!--/container-->
</div><!--/footer-->
<!--=== End Footer ===-->

<!--=== Copyright ===-->
<div class="copyright">
    <div class="container">
        <div class="row-fluid">
            <div class="span2">
              <a href="/">Rob Ashton</a>
            </div>
            <div class="span6">
              <p class="terms">2014 Â© Rob Ashton. ALL Rights Reserved.</p>
            </div>
        </div><!--/row-fluid-->
    </div><!--/container-->
</div><!--/copyright-->
<!--=== End Copyright ===-->

<!-- JS Global Compulsory -->
<script type="text/javascript" src="/assets/js/modernizr.custom.js"></script>
<script type="text/javascript" src="/assets/plugins/bootstrap/js/bootstrap.min.js"></script>
<!-- JS Implementing Plugins -->
<script type="text/javascript" src="/assets/plugins/flexslider/jquery.flexslider-min.js"></script>
<script type="text/javascript" src="/assets/plugins/parallax-slider/js/modernizr.js"></script>
<script type="text/javascript" src="/assets/plugins/parallax-slider/js/jquery.cslider.js"></script>
<script type="text/javascript" src="/assets/plugins/back-to-top.js"></script>
<script type="text/javascript" src="/assets/plugins/jquery.sticky.js"></script>
<script type="text/javascript" src="/assets/plugins/fancybox/source/jquery.fancybox.pack.js"></script>
<!-- JS Page Level -->
<script type="text/javascript" src="/assets/js/app.js"></script>
<script type="text/javascript" src="/assets/js/pages/index.js"></script>
<script type="text/javascript">
    jQuery(document).ready(function() {
      	App.init();
        App.initFancybox();
        App.initSliders();
        Index.initParallaxSlider();
    });
</script>
<!--[if lt IE 9]>
    <script src="assets/js/respond.js"></script>
<![endif]-->
  </body>
</html>

