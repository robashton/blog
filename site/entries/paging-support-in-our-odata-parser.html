<html>
  <head>
    <title id="title">Paging support in our OData parser</title>
    <link rel="stylesheet" type="text/css" href="/style.css"></link>
    <link href='http://fonts.googleapis.com/css?family=Libre+Baskerville' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
    <link rel="alternate" type="application/atom+xml" href="http://feeds.feedblitz.com/robashton&x=1" title="Rob Ashton's blog" />
    <meta name="Description" content="Rob Ashton's blog and various other things. Javascript, C#, testing, whatever.">
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-11207442-1']);
      _gaq.push(['_setDomainName', 'codeofrob.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </head>
  <body>
    <a class="subscribe" href="http://feed.codeofrob.com/RobAshton">Subscribe to my blog</a>
    <div id="blog-entry">
      <h1 id="post-title">Paging support in our OData parser</h1>
      <h6>Published on <span class="date">2013-4-11</span></h6>
      <div id="post"><p>As a reminder as to where we've gotten to so far, these are the tests that are currently passing:</p>

<pre><code>Parsing /
  ✓ Service root should have no model 

Parsing /model
  ✓ should have the resource specified 

Parsing /model(1)
  ✓ should have the resource specified 
  ✓ should have the key specified for the source 

Parsing /model(1)/child
  ✓ should have the resource specified 
  ✓ should have the key specified for the resource 
  ✓ should have the child specified 

Parsing /model(1)/$links/Child
  ✓ should have the resource specified 
  ✓ should have the key specified for the resource 
  ✓ should have the link specified 

Parsing /method(1)/child?foo=bar
  ✓ should have the resource specified 
  ✓ The result should be addressed 
  ✓ should have the path specified 
  ✓ should have the argument specified 

Parsing /resource?$orderby=Property
  ✓ sort options are present on the result 
  ✓ sort options have the property specified 

Parsing /resource?$orderby=PropertyOne,PropertyTwo
  ✓ sort options are present on the result 
  ✓ sort options have the first property specified 
  ✓ sort options have the second property specified 

Parsing /resource?$orderby=PropertyOne desc
  ✓ sort options are present on the result 
  ✓ sort options have the property specified 
  ✓ sort options have the property ordering specified 

Parsing /resource?$orderby=PropertyOne asc
  ✓ sort options are present on the result 
  ✓ sort options have the property specified 
  ✓ sort options have the property ordering specified 

Parsing /resource?$orderby=PropertyOne asc,PropertyTwo desc
  ✓ sort options are present on the result 
  ✓ sort options have property one name specified 
  ✓ sort options have property one ordering specified 
  ✓ sort options have the property two name specified 
  ✓ sort options have the property two ordering specified 

Parsing /resource?$orderby=PropertyOne/SubProperty
  ✓ sort options are present on the result 
  ✓ sort options have property one name specified 
  ✓ sort options have property one's sub property specified 
</code></pre>

<p>Which is nice. Now I want to add paging support in the form of </p>

<p>$top and $skip, while I'm at it I may as well add support for $inlinecount because it's pretty much the same thing.</p>

<p>This should be fairly easy, this is what I want to support:</p>

<pre><code>/some/path?$top=5&amp;limit=skip=100
/some/path?$inlinecount=allpages
</code></pre>

<p><strong>Top and Skip</strong></p>

<p>These are quite simple, just text and a number, let's write a couple of tests</p>

<pre><code>test("/some/resource?$top=5&amp;$skip=100", "OData", function(result) {
  it("top should be specified", function() {
     assert.equal(result.options.$top, 5)
  })
  it("skip should be specified", function() {
     assert.equal(result.options.$skip, 100)
  })
})
</code></pre>

<p>I just need to add these to the list of recognised query options</p>

<pre><code>QueryOption = 
    SortOption
  | TopOption
  | SkipOption
  | OperationParam
,
</code></pre>

<p>This is where the elegance of OMeta makes me really happy, being able to easily say what the options for something are in this way is really pretty.</p>

<p>So, TopOption</p>

<pre><code>TopOption = 
  seq("$top=") Number:value -&gt; { name: "$top", value: value }
,
</code></pre>

<p>and SkipOption</p>

<pre><code>SkipOption = 
  seq("$skip=") Number:value -&gt; { name: "$skip", value: value }
,
</code></pre>

<p>Can't say fairer than that!</p>

<p><strong>inlinecount</strong></p>

<p>This one is a bit more interesting, the only valid options are <em>none</em> and <em>allpages</em>, and we're supposed to return a 404 if we don't match. We're not currently doing anything with HTTP in this parser so what I'll actually do is accept "any text" and leave it up to the consumer to do this job for us. (Rather than throw a generic <em>I can't parse this</em> exception)</p>

<pre><code>test("/some/resource?$inlinecount=allpages", "OData", function(result) {
  it("inline should be specified", function() {
     assert.equal(result.options.$inlinecount, "allpages")
  })
})

test("/some/resource?$inlinecount=none", "OData", function(result) {
  it("inline should be specified", function() {
     assert.equal(result.options.$inlinecount, "none")
  })
})

test("/some/resource?$inlinecount=flibble", "OData", function(result) {
  it("inline should be specified", function() {
     assert.equal(result.options.$inlinecount, "")
  })
})
</code></pre>

<p>I want explicit handling for this because it'll help with the highlighting efforts in the editor that  this will be used in.</p>

<p>We can add it like so</p>

<pre><code>QueryOption = 
    SortOption
  | TopOption
  | SkipOption
  | InlineCountOption
  | OperationParam
,
</code></pre>

<p>And handle our explcit decisions like so</p>

<pre><code>InlineCountOption =
  seq("$inlinecount=") 
  (
    seq("allpages") -&gt; "allpages"
  | seq("none") -&gt; "none"
  | Text -&gt; ""
  ):value -&gt; { name: "$inlinecount", value: value }
,
</code></pre>

<p><strong>Et voila</strong></p>

<p>So that's paging done and dusted, incredibly simple when you know how. Next up we'll explore the murky world of OData filtering.</p></div>
      <div id="links">
        <a href="/">Index</a>
        <a href="http://feed.codeofrob.com/RobAshton">Subscribe</a>
        <a href="http://twitter.com/robashton">Follow me</a>
      </div>
      <div id="inqob_job_postings"></div> 
      <script type="text/javascript" charset="utf-8">
        var __inqob_settings = {
          email_address:  'robashton@codeofrob.com', 
          token:          '',
          debug: false,
          items: [{
            keyword: 'codeofrob', 
            price: 100 
          }]
        };

        (function(is) {
          var sc = document.createElement('script'); sc.type = 'text/javascript'; sc.async = true;
          var src = (document.location.protocol == 'https:' ? 'https://' : 'http://') + 'inqob.com/get/script';
          var q = [];
          q.push('?t='+ new Date().getTime()); 
          q.push('token=' + is.token); 
          q.push('email_address=' + is.email_address); 
          q.push('href=' + encodeURIComponent(window.location.href));
          sc.src = src + q.join('&');
          var s = document.getElementsByTagName('script')[0]; 
          s.parentNode.insertBefore(sc, s);
        })(__inqob_settings);      
      </script>
      <div id="disqus">
        <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'codeofrob'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
    </div>
    <div id="post-comments">

    </div>
  </body>
</html>
