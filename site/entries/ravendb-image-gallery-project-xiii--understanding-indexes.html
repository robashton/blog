<html>
  <head>
    <title id="title">RavenDB-Image Gallery Project (XIII)- Understanding Indexes</title>
    <link rel="stylesheet" type="text/css" href="/style.css"></link>
    <link rel="alternate" type="application/atom+xml" href="http://feeds.feedblitz.com/robashton&x=1" title="Rob Ashton's blog" />
    <meta name="Description" content="Rob Ashton's blog and various other things. Javascript, C#, testing, whatever.">
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-11207442-1']);
      _gaq.push(['_setDomainName', 'codeofrob.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </head>
  <body>
    <a class="subscribe" href="http://feed.codeofrob.com/RobAshton">Subscribe to my blog</a>
    <div id="blog-entry">
      <h1 id="post-title">RavenDB-Image Gallery Project (XIII)- Understanding Indexes</h1>
      <h6>Published on <span class="date">2010-10-19</span></h6>
      <div id="post">
		<p>The code for this and all other entries in this series can be found here: <a href="http://github.com/robashton/RavenGallery/">http://github.com/robashton/RavenGallery/</a></p>  <p>So far our image browser view just retrieves *all* of the documents from the document store, and allows paging through them. In other previous entries we have also written simple LINQ queries to check the existence of users and authenticate via username and password.</p>  <p>RavenDB makes it very easy for us to query our documents and not think about what is going on under the hood, and that can get us very far indeed before we have to do any manual work ourselves, but that can make the leap to advanced functionality quite a big one.</p>  <p>So, before we get that far it would be best to explain what is going on when you perform these basic queries against the document store. </p>  <p><strong>A basic query against a single property</strong></p>  <p>In RavenDB we can query a property on our document like so:</p>  <div class="csharpcode">   <pre class="alt">var query = documentSession.Query&lt;ImageDocument&gt;() </pre>

  <pre>        .Where(x=&gt;x.Title == <span class="str">"Something"</span>) </pre>

  <pre class="alt">        .ToArray(); </pre>
</div>
<style type="text/css">![CDATA[



.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }]]></style>

<p>In order for RavenDB to process this query, it must first create an Lucene index, which contains only the relevant properties copied from the document in question.</p>

<p>This takes place as another LINQ expression, which simply <strong><em>maps</em></strong> the properties from the document into a projection from that document. </p>

<div class="csharpcode">
  <pre class="alt">from doc <span class="kwrd">in</span> docs </pre>

  <pre>                              select <span class="kwrd">new</span> </pre>

  <pre class="alt">                              { </pre>

  <pre>                                  doc.Title </pre>

  <pre class="alt">                              }</pre>
</div>
<style type="text/css">![CDATA[



.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }]]></style>

<p>As new documents are added to the document store, or removed from the document store, these entries in the index are added and removed as the expression is invoked on those documents. This happens as a background process so there can be a small delay in documents being added to the store and being indexed, but it means that writes are really fast all the time, and that queries are incredibly cheap (as they are coming from a pre-computed index).</p>

<p>When performing an ad-hoc query against the document store, RavenDB is clever enough to extrapolate what this index should look like, and create it <em>if it does not already exist</em>.&nbsp; This temporary index will persist and the next call will re-use it and after the index has been re-used enough within a configured amount of time, it will be promoted into a permanent index and will therefore be available across server restarts.</p>

<p><strong>Pre-defining those indexes</strong></p>

<p>For the vast majority of queries, it is simply not necessary to pre-define those indexes, and it is best to just leave RavenDB to do what it wants to do – however it is beneficial to understand how to pre-define those indexes and understand how they work.</p>

<p>The .NET API allows us to pre-define an index in the following manner</p>

<div class="csharpcode">
  <pre class="alt">    <span class="kwrd">public</span> <span class="kwrd">class</span> Images_ByTitle : AbstractIndexCreationTask&lt;ImageDocument&gt;</pre>

  <pre>    {</pre>

  <pre class="alt">        <span class="kwrd">public</span> Images_ByTitle()</pre>

  <pre>        {</pre>

  <pre class="alt">            Map = docs =&gt; from doc <span class="kwrd">in</span> docs</pre>

  <pre>                          select <span class="kwrd">new</span></pre>

  <pre class="alt">                          {</pre>

  <pre>                              doc.Title</pre>

  <pre class="alt">                          };</pre>

  <pre>        }</pre>

  <pre class="alt">    }</pre>
</div>
<style type="text/css">![CDATA[
.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }]]></style><style type="text/css">![CDATA[



.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }]]></style>

<p>On start-up, we can register this (and any other indexes in the same assembly) by making a call to CreateIndexes against the document store:</p>

<p>IndexCreation.CreateIndexes(typeof(Images_ByTitle).Assembly, documentStore);</p>

<p>When querying, we can specify that we wish to use this index by including it as a parameter in the Query method like so</p>

<div class="csharpcode">
  <pre class="alt">documentSession.Query&lt;ImageDocument, Images_ByTitle&gt;() </pre>

  <pre>                    .Where(x=&gt;x.Title == <span class="str">"Something"</span>) </pre>

  <pre class="alt">                    .ToArray();</pre>
</div>
<style type="text/css">![CDATA[



.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }]]></style>

<p>Of course, now we are specifying which index to use, RavenDB can only query any properties that have been mapped into that index, so these pre-computed indexes are largely inappropriate for general use.</p>

<p>As many or as few properties can be mapped into an index as is desired, and as many or as few of these properties can be used in a query against that index, but you cannot query any properties that don’t exist in that index.</p>

<p>In order for LINQ to be used to query that index, there is a convention that the properties in the anonymous object created by the map expression should have the same name as the properties in the original document, but this is not entirely necessary – later in the series we might discuss some use cases for this and we can query without using the LINQ provider.</p>

<p>For the next few entries, any ad-hoc queries will also be accompanied with an explanation of the underlying index that will be created, so that when we reach the point where we <em>need</em> to create an index it should be easily understandable.</p>
	</div>
      <div id="links">
        <a href="/">Index</a>
        <a href="http://feed.codeofrob.com/RobAshton">Subscribe</a>
        <a href="http://twitter.com/robashton">Follow me</a>
      </div>
      <div id="inqob_job_postings"></div> 
      <script type="text/javascript" charset="utf-8">
        var __inqob_settings = {
          email_address:  'robashton@codeofrob.com', 
          token:          '',
          debug: false,
          items: [{
            keyword: 'codeofrob', 
            price: 100 
          }]
        };

        (function(is) {
          var sc = document.createElement('script'); sc.type = 'text/javascript'; sc.async = true;
          var src = (document.location.protocol == 'https:' ? 'https://' : 'http://') + 'inqob.com/get/script';
          var q = [];
          q.push('?t='+ new Date().getTime()); 
          q.push('token=' + is.token); 
          q.push('email_address=' + is.email_address); 
          q.push('href=' + encodeURIComponent(window.location.href));
          sc.src = src + q.join('&');
          var s = document.getElementsByTagName('script')[0]; 
          s.parentNode.insertBefore(sc, s);
        })(__inqob_settings);      
      </script>
      <div id="disqus">
        <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'codeofrob'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
    </div>
    <div id="post-comments"><div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=187e4cdfbc0279bdaf57a4ae58f3fc69&size=50&default=identicon"/>
<p>Matt Warren</p></div>
<div class="comment-body">
<br/> 				When you say "For the vast majority of queries, it is simply not necessary to pre-define those indexes"It might be worth adding that dynamic queries are not suitable if you need to do any sorting/ordering or if you need results that include all docs - straight away. In these cases creating indexes up front is still the best option.But dynamic queries are a *really* cool feature.
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=b6a6693f03003f7ab0f9b0882e9c2dde&size=50&default=identicon"/>
<p>Rob Ashton</p></div>
<div class="comment-body">
<br/> 				It's a difficult one, RavenDB does now support ordering on dynamic queries, and by the time you have enough data in the system for the dynamic nature of the query to be a problem, the query is probably permanent.
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=187e4cdfbc0279bdaf57a4ae58f3fc69&size=50&default=identicon"/>
<p>Matt Warren</p></div>
<div class="comment-body">
<br/> 				Sorry I didn't mean to say that dynamic queries can't sort, just that it causes problems.But I guess I was thinking about the situation where you already have a large dataset and you issue a new dynamic query. In that case the query will be stale for a long time, during which sorting might not return the correct results. But I admit it's not a common case.
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="/images/IdenticonHandler.ashx?code=739797881"/>
<p>Anders</p></div>
<div class="comment-body">
<br/> 				I think there need to be some more information on when I do need to pre-define some indexes. What can't/shouldn't I do with dynamic queries etc.
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=b6a6693f03003f7ab0f9b0882e9c2dde&size=50&default=identicon"/>
<p>Rob Ashton</p></div>
<div class="comment-body">
<br/> 				You're right, I am trying to do it within the context of this series however and there are still a lot of features I have left to cover :)Oren does a good summary of when you wouldn't want to use dynamic queries here: ayende.com/.../ravenrsquos-dynamic-queries.aspx
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=b72c018345724ee4e36b1cfa02b3d732&size=50&default=identicon"/>
<p>Nadav</p></div>
<div class="comment-body">
<br/> 				I have a question about the updating of the indexes being done in a background thread.Does this mean that if I add a document to the database and then query the database then the newly added document might not be in the query result?That seems a bit problematic to me...
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=b6a6693f03003f7ab0f9b0882e9c2dde&size=50&default=identicon"/>
<p>Rob Ashton</p></div>
<div class="comment-body">
<br/> 				That is indeed the case.This is always a possibility in any system which is built this way (most of the CQRSy patterns acknowledge this). Typically the solution is to design user interfaces that *assume* success and display the updated results immediately.If seeing 'up to date' results is massively important (and you should strive to avoid such situations), then you can always use WaitForNoneStaleResultsAsOfNow to make sure you have the latest indexed data.
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=b72c018345724ee4e36b1cfa02b3d732&size=50&default=identicon"/>
<p>Nadav</p></div>
<div class="comment-body">
<br/> 				Thanks, Rob.I'm just trying to think I you design the interface to avoid it.i.e. You add an item to the data, go back to the index page, and the Item you just added is not shown. The client's response will be WTF?!
				</div></div>
<div class="comment">
<div class="comment-author">
<img src="http://www.gravatar.com/avatar.php?gravatar_id=b6a6693f03003f7ab0f9b0882e9c2dde&size=50&default=identicon"/>
<p>Rob Ashton</p></div>
<div class="comment-body">
<br/> 				In a web application, rather than go to a different page, show an editor in-situ (JavaScript, it's the modern way anyway), when they add the item, you can add it to the list without requesting any data from the server at all.(Just one solution)
				</div></div>
</div>
  </body>
</html>
